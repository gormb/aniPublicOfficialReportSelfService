<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR-kode Generator</title>
  <script>
    // Prekalkuler Galois Field-tabeller for GF(256)
    const gfExp = new Array(512);
    const gfLog = new Array(256);
    {
      let x = 1;
      for (let i = 0; i < 255; i++) {
        gfExp[i] = x;
        gfLog[x] = i;
        x <<= 1;
        if (x & 0x100) { x ^= 0x11d; }
      }
      for (let i = 255; i < 512; i++) {
        gfExp[i] = gfExp[i - 255];
      }
    }
    function gfMul(a, b) {
      if (a === 0 || b === 0) return 0;
      return gfExp[gfLog[a] + gfLog[b]];
    }

    // Minimal QR-kodegenerator for QR versjon 1, error correction level L.
    // OBS! Denne implementasjonen støtter kun byte-modus for korte tekster (maks ca. 17 tegn).
    const qr = {
      // Oppretter et tomt QR-matrise (21x21 for versjon 1)
      _createMatrix: () => {
        const size = 21;
        return Array.from({ length: size }, () => Array(size).fill(null));
      },
      // Legger på de tre finder-patternene (øverst til venstre, øverst til høyre, og nede til venstre)
      _setupFinderPatterns: matrix => {
        const size = matrix.length;
        const pos = [[0,0], [size - 7, 0], [0, size - 7]];
        pos.forEach(([x, y]) => {
          for (let r = 0; r < 7; r++) {
            for (let c = 0; c < 7; c++) {
              if (r === 0 || r === 6 || c === 0 || c === 6 || (r >= 2 && r <= 4 && c >= 2 && c <= 4))
                matrix[y + r][x + c] = 1;
              else
                matrix[y + r][x + c] = 0;
            }
          }
        });
      },
      // Setter opp timing-pattern (både horisontalt og vertikalt)
      _setupTimingPatterns: matrix => {
        const size = matrix.length;
        for (let i = 8; i < size - 8; i++) {
          if (matrix[6][i] === null) matrix[6][i] = i % 2 === 0 ? 1 : 0;
          if (matrix[i][6] === null) matrix[i][6] = i % 2 === 0 ? 1 : 0;
        }
      },
      // En enkel byte-modus koding:
      // Legger til mode-indikator (0100), 8-bits lengde og 8-bits per tegn.
      // Deretter legges en terminator på, bitstrømmen padder opp til 19 kodeord (152 biter)
      _encodeData: text => {
        let bits = "0100"; // mode-indikator for byte-modus
        let len = text.length;
        bits += len.toString(2).padStart(8, '0');
        for (let i = 0; i < text.length; i++) {
          bits += text.charCodeAt(i).toString(2).padStart(8, '0');
        }
        bits += "0000"; // terminator
        while (bits.length % 8 !== 0) { bits += "0"; }
        const totalDataBits = 19 * 8; // 19 kodeord for versjon 1-L
        const padBytes = ["11101100", "00010001"];
        let padIndex = 0;
        while (bits.length < totalDataBits) {
          bits += padBytes[padIndex];
          padIndex = 1 - padIndex;
        }
        bits = bits.slice(0, totalDataBits);
        let dataCodewords = [];
        for (let i = 0; i < bits.length; i += 8) {
          dataCodewords.push(parseInt(bits.substr(i, 8), 2));
        }
        return dataCodewords;
      },
      // Regner ut error correction-kodeordene med Reed-Solomon (7 kodeord for versjon 1-L)
      _getErrorCorrection: dataCodewords => {
        const ecCount = 7;
        const gen = [87, 229, 146, 149, 238, 102, 21]; // standard generator-polynom
        let ec = Array(ecCount).fill(0);
        for (let i = 0; i < dataCodewords.length; i++) {
          let factor = dataCodewords[i] ^ ec[0];
          ec.shift();
          ec.push(0);
          for (let j = 0; j < ecCount; j++) {
            ec[j] ^= gfMul(gen[j], factor);
          }
        }
        return ec;
      },
      // Plasserer dataene (både data og error correction) inn i matrisen i det standard "zig-zag"-mønsteret.
      _placeData: (matrix, dataCodewords, ecCodewords) => {
        const size = matrix.length;
        const allCodewords = dataCodewords.concat(ecCodewords);
        let bits = "";
        allCodewords.forEach(code => {
          bits += code.toString(2).padStart(8, '0');
        });
        let bitIndex = 0;
        let directionUp = true;
        for (let col = size - 1; col > 0; col -= 2) {
          if (col === 6) col--; // hopp over timing-pattern-kolonnen
          for (let rowOffset = 0; rowOffset < size; rowOffset++) {
            let row = directionUp ? size - 1 - rowOffset : rowOffset;
            for (let c = col; c > col - 2; c--) {
              if (matrix[row][c] === null) {
                matrix[row][c] = bitIndex < bits.length ? parseInt(bits[bitIndex]) : 0;
                bitIndex++;
              }
            }
          }
          directionUp = !directionUp;
        }
      },
      // Konverterer matrisen til SVG der hver modul er 1x1
      _matrixToSVG: matrix => {
        const size = matrix.length;
        let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${size} ${size}" width="${size}" height="${size}">`;
        for (let y = 0; y < size; y++) {
          for (let x = 0; x < size; x++) {
            if (matrix[y][x] === 1) {
              svg += `<rect x="${x}" y="${y}" width="1" height="1" fill="black"/>`;
            }
          }
        }
        svg += `</svg>`;
        return svg;
      },
      // Returnerer en Base64-kodet SVG som kan brukes som src i et img-element.
      imgData: t => {
        t = t || window.location.href;
        let matrix = qr._createMatrix();
        qr._setupFinderPatterns(matrix);
        qr._setupTimingPatterns(matrix);
        const dataCodewords = qr._encodeData(t);
        const ecCodewords = qr._getErrorCorrection(dataCodewords);
        qr._placeData(matrix, dataCodewords, ecCodewords);
        const svg = qr._matrixToSVG(matrix);
        return btoa(unescape(encodeURIComponent(svg)));
      },
      // Returnerer et img-element som streng, med valgfri størrelse (sz + enhet u)
      svg: (t = window.location.href, sz = 40, u = 'dvw') => {
        return `<img src="data:image/svg+xml;base64,${qr.imgData(t)}" style="width:${sz}${u};height:${sz}${u};image-rendering: pixelated;" alt="QR Code"/>`;
      }
    };
  </script>
</head>
<body>
  QR-kode<br><br><br>

  QR-kode<script>document.write(qr.svg('https://bit.ly/ynugno'))

  </script>
</body>
</html>
