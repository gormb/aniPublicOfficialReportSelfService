;/*FB_PKG_DELIM*/

__d("CryptoUtils",["Base64Utils","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","MEBEncryptionVersion","SymmetricEncryptionCreateEncryptedData","SymmetricEncryptionPaddingUtils","XPlatReactCrypto","XPlatReactTextDecoder","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h=32,i=2147483647,j="message_key_in_epoch",k="_",l="cipher_version",m="thread",n="message_thread";function a(a,b,d,e){var f=d>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?null:o(e);a=p(a,d,e);if(a==null)throw c("err")("Error in derive message symmetric key. info is null");return r(a,f,b,[h])}function o(a){try{return new TextEncoder().encode(a).buffer}catch(a){throw c("err")("Error in get blob from string with exception: ",a)}}function p(a,b,c){a=q(a,b,c);return o(a)}function q(a,b,e){if(b>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY||b>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT)return[j,new(d("XPlatReactTextDecoder").TextDecoder)().decode(a),l,b,m,e!=null?e:""].join(k);else if(b>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION)return[j,new(d("XPlatReactTextDecoder").TextDecoder)().decode(a),l,b].join(k);else return[j,new(d("XPlatReactTextDecoder").TextDecoder)().decode(a)].join(k)}function r(a,b,e,f){if(f.length<1||f.some(function(a){return a>i}))throw c("err")("Invalid key lengths for derive keys");var g=f.reduce(function(a,b){return a+b},0)*8;return d("XPlatReactCrypto").subtleImportKey("raw",e,"HKDF",!1,["deriveBits"]).then(function(c){var e;return d("XPlatReactCrypto").subtleDeriveBits({hash:"SHA-256",info:a,name:"HKDF",salt:(e=b)!=null?e:new Uint8Array(10).buffer},c,g)}).then(function(a){a=new Uint8Array(a);var b=[],c=0;for(var d=0,e=f.length;d<e;++d){var g=c+f[d];b.push(a.slice(c,g).buffer);c=g}return b})["catch"](function(a){throw c("err")("Exception in create derived keys",a)})}function e(a,b,e){e=d("Base64Utils").toArrayBuffer(e);return s(a,b,e).then(function(a){return a}).then(function(a){if(a==null)throw c("err")("symmetric string decryption with null result");return new(d("XPlatReactTextDecoder").TextDecoder)().decode(a)})["catch"](function(a){throw c("err")("symmetric string decryption failed with error",a)})}function s(a,b,e){if(e.byteLength<d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes)throw c("err")("cipher text is invalid");e=new Uint8Array(e);var f=e.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes),g=new(d("HChaCha20").HChaCha20)(),h=e.slice(d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer;e=g.hChaCha20Bytes(f.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,a);return d("XPlatReactCrypto").subtleImportKey("raw",e,"AES-GCM",!1,["decrypt"]).then(function(a){return d("XPlatReactCrypto").subtleDecrypt({additionalData:b,iv:new Uint8Array(f.slice(d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},a,h)}).then(function(a){a=d("SymmetricEncryptionPaddingUtils").stripPadding(a);if(a==null)throw c("err")("Failed to strip padding for symmetric decryption");return a})["catch"](function(a){throw c("err")("symmetric data decryption failed with error",a)})}function f(a,b,c){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){b=(yield c("SymmetricEncryptionCreateEncryptedData")(b,new TextEncoder().encode([n,e].join(k)).buffer,a));e=b[0];return e!=null?d("Base64Utils").fromArrayBuffer(e):null});return t.apply(this,arguments)}g.KEY_LEN=h;g.MAX_INT_32=i;g.STRING_JOIN_SEPARATOR=k;g.MESSAGE_ENCYPTION_AAD=n;g.deriveMessageSymmetricKey=a;g.getBlobFromString=o;g.createDerivedKeys=r;g.symmetricEncryptionCreateDecryptedString=e;g.encryptThenBase64EncodeBlob=f}),98);
__d("PublicEncryptionCreateEncryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","UInt8Array","XPlatReactCrypto","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateEncryptedData"),j=c("requireDeferred")("X25519").__setRef("PublicEncryptionCreateEncryptedData");function k(a,b){if(a.byteLength>32)return b("PSK is too long")}function l(a,c){return new(h||(h=b("Promise")))(function(b,e){d("PublicKeyEncryptionUtils").assertValidCurvePoint(c,e);k(a,e);return b()})}function a(a,c,e,f,g,k){var m=new Uint8Array([1]),n=new Uint8Array(g),o=d("PublicKeyEncryptionUtils").getSalt(f),p=new Uint8Array(a),q=new Uint8Array(c),r=new Uint8Array(e);return(h||(h=b("Promise"))).all([d("PublicKeyEncryptionUtils").assertKeyLength(p),d("PublicKeyEncryptionUtils").assertKeyLength(q),d("PublicKeyEncryptionUtils").assertKeyLength(r)]).then(function(){return l(o,p)}).then(function(){return j.load()}).then(function(a){var c=a.generateKeys(a.KeyPurpose.Encryption),e=c.pk,f=d("PublicKeyEncryptionUtils").concatAad(m,q,p,e,n);e=function(c,d,e){c=a.publicKeyFromBytes(c,a.KeyPurpose.Encryption);d=a.publicKeyFromBytes(d,a.KeyPurpose.Encryption);e=a.secretKeyFromBytes(e,a.KeyPurpose.Encryption);return c==null||d==null||e==null?(h||(h=b("Promise"))).resolve():(h||(h=b("Promise"))).resolve([c,d,e])};return e(p,q,r).then(function(a){return a==null?null:{ephemeralPriv:c.sk,ephemeralPubBytes:c.pk,innerAad:f,receiverPub:a[0],senderPriv:a[2],senderPub:a[1]}})}).then(function(a){if(a==null)return;var b=a.ephemeralPubBytes,c=a.ephemeralPriv,e=a.senderPriv,f=a.receiverPub,g=a.innerAad;return i.load().then(function(a){return a.senderDeriveSharedSecret(e,c,f)}).then(function(a){if(a==null)return;return d("PublicKeyEncryptionUtils").getAesKey(a,o,g,"encrypt")}).then(function(a){if(a==null)return;var b=new Uint8Array(12).buffer;return d("XPlatReactCrypto").subtleEncrypt({additionalData:g,iv:new Uint8Array(b),name:"AES-GCM",tagLength:128},a,k)}).then(function(a){if(a==null)return;a=new Uint8Array(a);return d("UInt8Array").concatBytes([m,b,a]).buffer})}).then(function(a){return(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult(a))})["catch"](function(a){var c=d("CryptoLogger").CryptoLogger("public_encryption_create_encrypted_data");d("CryptoLogger").captureError(c,a).mustfix("Creation of encrypted data for public encryption failed");return(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult(void 0))})}g["default"]=a}),98);
__d("EpochUtils",["Base64Utils","CryptoUtils","I64","LSBase64Decode","LSCryptoUtils","Promise","PublicEncryptionCreateDecryptedData","PublicEncryptionCreateEncryptedData","XPlatReactTextDecoder","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j="epoch_chaining",k="epoch_root_key",l="epoch_data_storage",m="epoch_data_metadata",n=18;function a(a){try{var b=d("LSCryptoUtils").strToBuf("0"),c;if(a!=null){a=a;if(a.byteLength===0)c=b;else{var e=new(d("XPlatReactTextDecoder").TextDecoder)();e=e.decode(a);a=Number.parseInt(e,10);e=a+1;c=d("LSCryptoUtils").strToBuf(e.toString())}}else c=b;return c}catch(a){throw a}}function e(a,b,c){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f,g=[(f=d("CryptoUtils")).KEY_LEN,f.KEY_LEN];f=f.getBlobFromString([j,a,(i||(i=d("I64"))).to_string(b)].join(d("CryptoUtils").STRING_JOIN_SEPARATOR));if(f==null)throw c("err")("infoForEpochChaining is empty");a=(yield d("CryptoUtils").createDerivedKeys(f,null,e,g));return{epoch_chaining_key:a[0],epoch_distribution_pre_shared_key:a[1]}});return o.apply(this,arguments)}function f(a,b,c,d,e,f){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,d,e,f,g){a=(yield c("PublicEncryptionCreateDecryptedData")(a,b,d,e,s(f),g));return a[0]});return p.apply(this,arguments)}function q(a,b,c,d,e,f){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,d,e,f,g){a=(yield c("PublicEncryptionCreateEncryptedData")(a,b,d,e,s(f),g));return a[0]});return r.apply(this,arguments)}function s(a){return new TextEncoder().encode(["epoch_",a].join(d("CryptoUtils").STRING_JOIN_SEPARATOR)).buffer}function t(a,b,c,d){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){a=(yield d("CryptoUtils").createDerivedKeys(a,b,c,e));return a[0]});return u.apply(this,arguments)}function v(a,b){var e=d("CryptoUtils").getBlobFromString(k);if(e==null)throw c("err")("epochRootKey is empty");return t(e,a,b,[d("CryptoUtils").KEY_LEN])}function w(a,b){b=new TextEncoder().encode("meb/debug/fingerprint/"+b).buffer;if(b==null)throw c("err")("blob type for which fingerprints are supported is empty");return t(b,null,a,[n])}function x(a,b,c){return y.apply(this,arguments)}function y(){y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var f=[d("CryptoUtils").KEY_LEN];c=d("Base64Utils").fromArrayBuffer(c);a=[a,c].join(d("CryptoUtils").STRING_JOIN_SEPARATOR);c=(yield d("CryptoUtils").createDerivedKeys(new TextEncoder().encode(a).buffer,null,e,f));return c.length===0?(h||(h=b("Promise"))).resolve():c[0]});return y.apply(this,arguments)}function z(a){return x(l,a.epochAnonIdBlob,a.epochRootKeyBlob)}function A(a,b){return B.apply(this,arguments)}function B(){B=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b=d("Base64Utils").fromArrayBuffer(b);b=(yield C(b,a,m));if(b==null)throw c("err")("symmetricDecryptAndBase64Decode output is empty while decrypting backward edge");return b});return B.apply(this,arguments)}function C(a,b,c){return D.apply(this,arguments)}function D(){D=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){e=d("LSBase64Decode").decode(e);if(e==null)throw c("err")("aadBuffer is empty");b=(yield d("CryptoUtils").symmetricEncryptionCreateDecryptedString(b,e,a));if(b==null)throw c("err")("decrypted_string_base64 is empty");return d("LSBase64Decode").decode(b)});return D.apply(this,arguments)}g.getNextEpochId=a;g.generateEpochChainingAndDistributionPreSharedKey=e;g.decryptEpochKey=f;g.generateEncryptedEpochKey=q;g.deriveKey=t;g.generateEpochRootKey=v;g.getFingerPrint=w;g.createDerivedKeysForEpoch=x;g.deriveBackwardEdgeKey=z;g.decryptBackwardEdge=A}),98);
__d("LSEpochStatus",[],(function(a,b,c,d,e,f){a=Object.freeze({ES_OPEN:1,ES_CLOSE:2});f["default"]=a}),66);
__d("DeriveAndStoreEpochs",["Base64Utils","EpochUtils","I64","LSAuthorityLevel","LSBase64Decode","LSEpochStatus","Promise","ReQL","WACryptoUtils","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a,b,c,d){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g,h=(yield d("EpochUtils").getNextEpochId(f.epochAnonIdBlob));if(new TextDecoder().decode(h)!==(e==null?void 0:(h=e.to_epoch)==null?void 0:h.epoch_anon_id))throw c("err")("epoch forward edge not consecutive");h=e==null?void 0:(h=e.from_epoch)==null?void 0:h.epoch_id;g=e==null?void 0:(g=e.from_epoch)==null?void 0:g.epoch_anon_id;if(h==null||g==null)throw c("err")("fromEpochId or fromEpochAnonId is null");g=(yield d("EpochUtils").generateEpochChainingAndDistributionPreSharedKey(g,(i||(i=d("I64"))).of_string(h),f.epochRootKeyBlob));h=g.epoch_distribution_pre_shared_key;f=(yield d("EpochUtils").getFingerPrint(h,"MEBCryptoPreSharedKey"));if((b==null?void 0:b.psk_fingerprint)!==d("Base64Utils").fromArrayBuffer(f))throw c("err")("epoch derivation psk fingerprint mismatch");f=b==null?void 0:b.epoch_storage_public_key;if(d("Base64Utils").fromArrayBuffer(a.epochStoragePublicKeyBlob)!==f)throw c("err")("epoch derivation storage key mismatch");f=b==null?void 0:b.auth_public_key;if(f==null)throw c("err")("original device auth public key is null");e=e==null?void 0:(e=e.to_epoch)==null?void 0:e.epoch_anon_id;if(e==null)throw c("err")("target epoch anon id is null");b=b==null?void 0:b.encrypted_entropy;if(b==null)throw c("err")("target entropy is null");f=d("LSBase64Decode").decode(f);if(f==null)throw c("err")("original_device_auth_public_key_buffer is null");b=d("LSBase64Decode").decode(b);if(b==null)throw c("err")("encrypted_entropy_buffer is null");a=(yield d("EpochUtils").decryptEpochKey(a.epochStoragePublicKeyBlob,a.epochStoragePrivateKeyBlob,f,h,e,b));if(a==null)throw c("err")("entropy is null in epoch derivation");return d("EpochUtils").generateEpochRootKey(g.epoch_chaining_key,a)});return k.apply(this,arguments)}function l(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){b=b==null?void 0:(b=b.to_epoch)==null?void 0:b.epoch_anon_id;if(b==null)throw c("err")("target epoch id is null");b=d("EpochUtils").getNextEpochId(d("LSBase64Decode").decode(b));if(d("WACryptoUtils").arrayBuffersEqual(b,a.epochAnonIdBlob))throw c("err")("epoch backward edge not consecutive");b=(yield d("EpochUtils").deriveBackwardEdgeKey(a));if(b==null)throw c("err")("epoch data storage key is null");return d("EpochUtils").decryptBackwardEdge(b,e)});return m.apply(this,arguments)}function n(a,b){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e,g,h=(yield a.runInTransaction(function(a){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.secure_encrypted_backups_client_state))},"readwrite",void 0,void 0,f.id+":141"));if(h==null)throw c("err")("client state is null");var k=b==null?void 0:(e=b.from_epoch)==null?void 0:e.epoch_id;if(k==null)throw c("err")("fromEpochId is null");e=(yield a.runInTransaction(function(a){return a.secure_encrypted_backups_epochs.get((i||(i=d("I64"))).of_string(k))},"readwrite",void 0,void 0,f.id+":153"));if(e==null)throw c("err")("source epoch is missing");g=b==null?void 0:(g=b.from_epoch)==null?void 0:g.epoch_anon_id;if(new TextDecoder().decode(e.epochAnonIdBlob)!==g)throw c("err")("epoch derivation source epoch anon id mismatch");g=b==null?void 0:b.from_epoch_fingerprint;var m=(yield d("EpochUtils").getFingerPrint(e.epochRootKeyBlob,"MEBEpochRootKey"));if(d("Base64Utils").fromArrayBuffer(m)!==g)throw c("err")("epoch derivation source epoch fingerprint mismatch");m=b==null?void 0:b.forward_edge;var n;if(m!=null)n=(yield j(h,m,b,e));else{g=b==null?void 0:b.backward_edge;if(g==null)throw c("err")("backward edge is null");n=(yield l(e,b,new TextEncoder().encode(g).buffer))}m=b==null?void 0:b.to_epoch_fingerprint;e=(yield d("EpochUtils").getFingerPrint(n,"MEBEpochRootKey"));if(m!==d("Base64Utils").fromArrayBuffer(e))throw c("err")("epoch derivation target epoch fingerprint mismatch");var o=b==null?void 0:(g=b.to_epoch)==null?void 0:g.epoch_id,p=b==null?void 0:(m=b.to_epoch)==null?void 0:m.epoch_anon_id;if(o==null||p==null)throw c("err")("target epoch id or anon id is null");yield a.runInTransaction(function(a){return a.secure_encrypted_backups_epochs.put({authorityLevel:(i||(i=d("I64"))).of_float(c("LSAuthorityLevel").AUTHORITATIVE),backupId:h.backupId,epochAnonIdBlob:new TextEncoder().encode(p).buffer,epochId:i.of_string(o),epochRootKeyBlob:n,epochStatus:i.of_float(c("LSEpochStatus").ES_CLOSE)})},"readwrite",void 0,void 0,f.id+":209")});return o.apply(this,arguments)}function a(a,c){return(h||(h=b("Promise"))).all((c=c==null?void 0:c.epoch_edges.map(function(b){return n(a,b)}).filter(Boolean))!=null?c:[])}g.deriveAndStoreEpochs=a}),98);
__d("EBAPISharedUtils",["EBAPIQPLPoints","I64","LSAuthorityLevel","LSDeleteAndReenrollDeviceStateStoredProcedure","LSFactory","LSIntEnum","LSMEBDeviceReenrollmentReason","MAWBridgeSafeActionsWorkerAndUI","MWEBODSEntityName.enum","ODS","WALogger","asyncToGeneratorRuntime","handleRestoreMessagesGraphQLResponse"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Echo to protobuf conversion failed in search range restore response: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backup_id is null during graphQL restore"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is not complete - cannot proceed with graphQL restore"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is null - cannot proceed with graphQL restore"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] server side exception during graphql restore - ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] GQL worker range restore query returned null for message response"]);p=function(){return a};return a}function a(a,b){if(a!=null){b=b.filter(function(a){return(h||(h=d("I64"))).equal(a.authorityLevel,(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))}).map(function(a){return(h||(h=d("I64"))).to_string(a.epochId)});return{backupId:a.backupId,device_id:a.deviceId,locally_available_epochs:b,mailboxRootKey:a.mailboxRootKeyBlob,ocmfClientStateBlob:a.ocmfClientStateBlob}}}function e(a){var b=a==null?void 0:a.backupTenancy;a=a==null?void 0:a.authorityLevel;return b==null||a==null?!1:(h||(h=d("I64"))).equal((i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE),a)}function q(a){var b=a.backupId,c=a.devicePrivateKeyBlob,d=a.devicePublicKeyBlob,e=a.epochAuthPrivateKeyBlob,f=a.epochAuthPublicKeyBlob,g=a.epochStoragePrivateKeyBlob,h=a.epochStoragePublicKeyBlob,i=a.mailboxRootKeyBlob,j=a.obliviousValidationTokenBlob,k=a.ocmfClientStateBlob;if(b!=null&&c!=null&&d!=null&&e!=null&&f!=null&&g!=null&&h!=null&&i!=null&&j!=null&&k!=null)return{authorityLevel:a.authorityLevel,backupId:b,backupTenancy:a.backupTenancy,deviceId:a.deviceId,devicePrivateKeyBlob:c,devicePublicKeyBlob:d,encryptionVersion:a.encryptionVersion,epochAuthPrivateKeyBlob:e,epochAuthPublicKeyBlob:f,epochStoragePrivateKeyBlob:g,epochStoragePublicKeyBlob:h,mailboxRootKeyBlob:i,obliviousValidationTokenBlob:j,ocmfClientStateBlob:k,revisionVersion:a.revisionVersion}}function r(a){var b=a.authorityLevel,c=a.backupId,d=a.epochAnonIdBlob,e=a.epochId,f=a.epochRootKeyBlob;a=a.epochStatus;if(b!=null&&c!=null&&d!=null&&e!=null&&f!=null&&a!=null)return{authorityLevel:b,backupId:c,epochAnonIdBlob:d,epochId:e,epochRootKeyBlob:f,epochStatus:a}}function s(a){var b=[],c=new Set(["epochId","authorityLevel","backupId","epochAnonIdBlob","epochRootKeyBlob","epochStatus"]);a=a.get("secure_encrypted_backups_epochs");if(a==null||(a==null?void 0:a.size)===0)return b;if(a!=null){a=a.entries();for(a of a){var d=a[0];a[1];d=d;if(d instanceof Object){d=Object.values(d);d=d[1];if(d instanceof Object){var e={};for(d of Object.entries(d)){var f=d[0],g=d[1];c.has(f)&&(e[f]=g)}f=r(e);f!=null&&b.push(f)}}}}return b}function t(a){a=a.get("secure_encrypted_backups_client_state");var b={};if(a==null||(a==null?void 0:a.size)===0)return;if(a!=null){a=a.entries();for(a of a){var c=a[0];a[1];c=c;if(c instanceof Object){c=Object.values(c);c=c[1];if(c instanceof Object)for(c of Object.entries(c)){var d=c[0],e=c[1];b[d]=e}}break}}d=q(b);return d}function u(a){(j||(j=d("ODS"))).bumpEntityKey(7319,c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,a)}function v(a,b,c,d,e,f,g,h,i,j,k,l){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,g,j,q,r,s,t,u,v,w){var x;d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END,void 0,j);if(a==null||(a==null?void 0:(x=a.viewer)==null?void 0:(x=x.encrypted_backup)==null?void 0:x.mailbox)==null){d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,j);return{response:"invalid-graphql-response",success:!1}}a=(x=a==null?void 0:(x=a.viewer)==null?void 0:(x=x.encrypted_backup)==null?void 0:(x=x.mailbox)==null?void 0:x.messages)!=null?x:a==null?void 0:(x=a.viewer)==null?void 0:(a=x.encrypted_backup)==null?void 0:(x=a.mailbox)==null?void 0:x.messages_point_restore;if(a==null){d("WALogger").ERROR(p());d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,j);return{response:"invalid-graphql-response",success:!1}}x=a;if((x==null?void 0:x.encrypted_messages)==null){d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,j);return{response:"invalid-graphql-response",success:!1}}a=x.backup_id;var y=x.encrypted_messages,z=x.epoch_derivation_set,A=x.exception_string,B=x.message_range_info;x=x.should_delete_mailbox;if(A!=null){d("WALogger").ERROR(o(),A);x===!0&&(d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX,void 0,j),yield g.runInTransaction(function(a){return c("LSDeleteAndReenrollDeviceStateStoredProcedure")(c("LSFactory")(a),{reenrollmentReason:(i||(i=d("LSIntEnum"))).ofNumber(c("LSMEBDeviceReenrollmentReason").RESTORE_FAILED_WITH_NO_DEVICE_FOUND),targetDeviceId:q})},"readwrite",void 0,void 0,f.id+":335"));d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,j,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:A}});return{response:"server-side-exception",success:!1}}d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START,void 0,j);yield d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(z,g,q,u,b);d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END,void 0,j);if(B==null){d("WALogger").ERROR(n());d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,j);return{response:"missing-message-range-info",success:!1}}if(B!=null){x=B.has_more_after;A=B.has_more_before;z=B.next_message_timestamp_ms_after;var C=B.next_message_timestamp_ms_before;if(A==null||x==null||z==null||C==null){d("WALogger").ERROR(m());d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,j);return{response:"missing-message-range-info",success:!1}}}a==null&&(d("WALogger").WARN(l()),d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL,void 0,j));d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_START,void 0,j);A=(yield d("handleRestoreMessagesGraphQLResponse").processEncryptedMessagesWithoutPersisting({backupId:a!=null?a:(h||(h=d("I64"))).to_string(w),encryptedMessages:y,messageRangeInfo:B,qplEvent:e,runningInWorker:b,sortOrderMs:v,source:t,storage:g,threadId:r,traceId:u}));d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_END,void 0,j);if(A==null){d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.EMPTY_DECRYPTION_RESPONSE,j);return{response:"empty-decryption-response",success:!1}}if(A.echoMessages!=null){x=A;z=x.echoMessages;d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.ECHO_TO_PROTOBUF_CONVERSION_START,void 0,j);try{C=(yield d("MAWBridgeSafeActionsWorkerAndUI").sendAndReceiveBackendWorkerAndUIShared("convertEchoMessagesToEBProtobufs",{chatJid:s,encodedEchoMessages:z}));d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.ECHO_TO_PROTOBUF_CONVERSION_END,void 0,j);A=babelHelpers["extends"]({},A,{echoMessages:void 0,protobufMessages:(A.protobufMessages||[]).concat(C)})}catch(a){d("WALogger").ERROR(k(),a.message);d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.ECHO_TO_PROTOBUF_CONVERSION_FAILURE,j);return{response:"echo-to-protobuf-conversion-error",success:!1}}}d("EBAPIQPLPoints").ebAPIEndSuccess(b,e,j,{bool:{isEcho:((a=A)==null?void 0:a.echoMessages)?((w=A)==null?void 0:w.echoMessages.length)>0:!1,isProtobuf:((y=A)==null?void 0:y.protobufMessages)?((B=A)==null?void 0:B.protobufMessages.length)>0:!1}});return{response:A,success:!0}});return w.apply(this,arguments)}g.getDeviceAndKeyMetadata=a;g.isBackupTenancyAuthoritative=e;g.getAvailableEpochsFromPersistedEBSM=s;g.getClientStateFromPersistedEBSM=t;g.bumpOdsRestoreKey=u;g.constructEBRestoreResponse=v}),98);
__d("EBMessagePointQueryWithPersistenceQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="9664280036967963"}),null);
__d("EBMessagePointQueryWithPersistenceQuery.graphql",["EBMessagePointQueryWithPersistenceQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessagePointQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessagePointQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessagePointQueryWithPersistenceQuery_facebookRelayOperation"),metadata:{},name:"EBMessagePointQueryWithPersistenceQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBMessagePointQueryWithPersistence",["Base64Utils","EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBIsEbEnabled","EBMessagePointQueryWithPersistenceQuery.graphql","EBSMHydrationUtils","I64","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSDeleteAndReenrollDeviceStateStoredProcedure","LSEncryptedBackupsBackupTenancy","LSFactory","LSIntEnum","LSMEBDeviceReenrollmentReason","LSMEBTaskCreationSource","LSShape","LSVec","MAWBridge","MAWCurrentUser","MAWEBRestoreTrackingUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsPersistedDB","MAWJobDefinitions","MAWMainTraceUtils","QPLUserFlow","WAHashStringToNumber","WALogger","WAResultOrError","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","cr:14165","gkx","handleRestoreMessagesGraphQLResponse","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] graphQL point restore error ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with error: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with an error"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with error: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with an error."]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is not complete - cannot proceed with graphQL restore"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backup_id is null during graphQL restore"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is null - cannot proceed with graphQL restore"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] server side exception during graphql restore - ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] GQL worker point restore query returned null for message response"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory params of client state are null"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No client state found - unable to restore"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No client state found - unable to restore"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Calling EBLS without EBLS being available for message point query"]);x=function(){return a};return a}var y=h!==void 0?h:h=b("EBMessagePointQueryWithPersistenceQuery.graphql");function a(a){return z.apply(this,arguments)}function z(){z=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e,f=a.jid,g=a.messageId,h=a.sortOrderMs,z=a.source,A=a.threadId;a=a.traceId;if(!d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql");var B=a!=null?a:d("MAWMainTraceUtils").createTraceId(),C=d("WAHashStringToNumber").hashStringToNumber(B),D=c("qpl")._(521474469,"2612");c("QPLUserFlow").start(D,{annotations:{bool:{mainThreadRestore:!1,workerThreadRestore:!0},"int":{source:(e=z)!=null?e:c("LSMEBTaskCreationSource").UNKNOWN}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestorePoint(z,B,"GQL_WORKER",!0);try{var E;if(b("cr:14165")==null){d("WALogger").ERROR(x());c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.EBLS_NOT_INITIALIZED,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.EBLS_NOT_INITIALIZED}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"ebls_not_initialized");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("ebls-not-intialized")}c("QPLUserFlow").addPoint(D,"before_ebls_initialization",{instanceKey:C});yield b("cr:14165").genLSClient();c("QPLUserFlow").addPoint(D,"after_ebls_initialization",{instanceKey:C});e=(yield b("cr:14165").getLSStorage());var F=(yield d("EBIsEbEnabled").isEbEnabledLS(e.tables));if(c("gkx")("2489")){var G=d("MAWEncryptedBackupsPersistedDB").getEBLSDB();G=(yield d("EBSMHydrationUtils").loadEBdataToEphemeralRestore(G));var H=d("EBAPISharedUtils").getClientStateFromPersistedEBSM(G);G=d("EBAPISharedUtils").getAvailableEpochsFromPersistedEBSM(G);if(H===null){d("WALogger").ERROR(w());c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"no_client_state");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("no-client-state")}var I=F!=null?F:d("EBAPISharedUtils").isBackupTenancyAuthoritative(H);if(!I){c("QPLUserFlow").addPoint(D,"eb_not_enabled",{instanceKey:C});c("QPLUserFlow").endSuccess(D,{instanceKey:C});d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"eb_not_enabled",traceId:B});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(B,!0);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.success");return d("WAResultOrError").makeResult()}I=d("EBAPISharedUtils").getDeviceAndKeyMetadata(H,G)}else{H=(yield d("MAWEncryptedBackupUtils").getBackupTenancy(e.tables));G=F!=null?F:H!=null&&(i||(i=d("I64"))).equal(H,(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION));if(!G){c("QPLUserFlow").addPoint(D,"eb_not_enabled",{instanceKey:C});c("QPLUserFlow").endSuccess(D,{instanceKey:C});d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"eb_not_enabled",traceId:B});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(B,!0);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.success");return d("WAResultOrError").makeResult()}d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"lsdb_singleton_retrieved",traceId:B});c("QPLUserFlow").addPoint(D,"lsdb_singleton_retrieved",{instanceKey:C});I=(yield d("handleRestoreMessagesGraphQLResponse").getClientState(e))}if(I==null){d("WALogger").ERROR(v());c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"no_client_state");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("no-client-state")}F=I;H=F.backupId;var J=F.device_id;G=F.locally_available_epochs;var K=F.mailboxRootKey;F=F.ocmfClientStateBlob;if(H==null||J==null||K==null||F==null){d("WALogger").ERROR(u());c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:{string:{device_id:(i||(i=d("I64"))).to_string((E=(E=I)==null?void 0:E.device_id)!=null?E:(i||(i=d("I64"))).zero)}},pointName:"client_state_retrieved",traceId:B});c("QPLUserFlow").addPoint(D,"client_state_retrieved",{data:{string:{device_id:i.to_string((I=(E=I)==null?void 0:E.device_id)!=null?I:(i||(i=d("I64"))).zero)}},instanceKey:C});E=d("MAWCurrentUser").getAppID();d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"app_id_retrieved",traceId:B});c("QPLUserFlow").addPoint(D,"app_id_retrieved",{instanceKey:C});I={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(A),site:"www",tam_thread_subtype:0},success:babelHelpers["extends"]({device_context:{device_id:i.to_string(J),locally_available_epochs:G,raw_tokens:{mailbox_root_key:d("Base64Utils").fromArrayBuffer(K),ocmf_client_state_blob:d("Base64Utils").fromArrayBuffer(F)}},message_id:g},h!=null?{reference_timestamp:h}:{})};d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"graphql_query_start",traceId:B});c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START,{instanceKey:C});yield d("WorkerRelayNetwork").createWorkerNetworkExecute();K=(yield d("WorkerRelay").createWorkerQuery(y,{app_id:String((G=E)!=null?G:"0"),restore_payload_string:JSON.stringify(I),restore_type:"POINT_QUERY_RESTORE"}));d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"graphql_query_end",traceId:B});c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END,{instanceKey:C});if(K==null||(K==null?void 0:(F=K.viewer)==null?void 0:(g=F.encrypted_backup)==null?void 0:g.mailbox)==null){c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"gql_point_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}F=K==null?void 0:(E=K.viewer)==null?void 0:(G=E.encrypted_backup)==null?void 0:(I=G.mailbox)==null?void 0:I.messages_point_restore;if(F==null){d("WALogger").ERROR(t());c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"gql_point_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}g=F;if((g==null?void 0:g.encrypted_messages)==null){c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES}},instanceKey:C});d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"null_messages",traceId:B});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"null_messages");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}K=g.backup_id;E=g.encrypted_messages;G=g.epoch_derivation_set;I=g.exception_string;F=g.message_range_info;g=g.should_delete_mailbox;if(I!=null){d("WALogger").ERROR(s(),I);g===!0&&(c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX,{instanceKey:C}),yield e.runInTransaction(function(a){return c("LSDeleteAndReenrollDeviceStateStoredProcedure")(c("LSFactory")(a),{reenrollmentReason:(j||(j=d("LSIntEnum"))).ofNumber(c("LSMEBDeviceReenrollmentReason").RESTORE_FAILED_WITH_NO_DEVICE_FOUND),targetDeviceId:J})},"readwrite"),d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"delete_mailbox",traceId:B}));c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:I}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:I}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("server-side-exception")}d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"derive_and_store_epochs_start",traceId:B});c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START,{instanceKey:C});c("QPLUserFlow").addAnnotations(D,{bool:{hasEpochs:G!=null&&G.epoch_edges.length>0}},{instanceKey:C});yield d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(G,e,J,B,!0);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"derive_and_store_epochs_end",traceId:B});c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END,{instanceKey:C});E.length===0&&(c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_MESSAGES_TO_RESTORE,{instanceKey:C}),d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"no_messages",traceId:B}));if(F==null){d("WALogger").ERROR(r());c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"missing_message_range_info");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}K==null&&(d("WALogger").WARN(q()),c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL,{instanceKey:C}),d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"backup_id_null",traceId:B}));g=F.has_more_after;I=F.has_more_before;G=F.next_message_timestamp_ms_after;F=F.next_message_timestamp_ms_before;if(I==null||g==null||G==null||F==null){d("WALogger").ERROR(p());c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"message_range_info_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}E=d("handleRestoreMessagesGraphQLResponse").processMessageArray(E,K!=null?K:(i||(i=d("I64"))).to_string(H),D,C);var L=E.encryptedLSEchoMessages,M=E.encryptedMessagesWithProtobufs;if(M.length===0){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypt_messages_echo_start",traceId:B});c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START,{instanceKey:C});K=(yield e.runInTransaction(function(a){return c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:A,encryptedMessages:c("LSVec").ofArray(L)})},"readwrite"));H=K[0];E=K[1];if(E!=null){K=d("LSShape").toRecord(E);d("WALogger").ERROR(o());d("WALogger").WARN(n(),K.error_message);c("QPLUserFlow").endFailure(D,"ECHO_DECRYPTION_FAILURE",{annotations:{string:{error_description:K.error_message}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!1,"ECHO_DECRYPTION_FAILURE",{string:{error_description:K.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("echo-decryption-failure")}d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypt_messages_echo_end",traceId:B});c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END,{instanceKey:C});E=H;if(E!=null){K=c("LSVec").toArray(E).map(function(a){return d("LSShape").toRecord(a).value});c("promiseDone")(d("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:f,echoMessages:c("LSVec").ofArray(K),hasMoreAfter:g,hasMoreBefore:I,isPointQuery:!0,nextMessageTimestampMsAfter:(i||(i=d("I64"))).of_string(G),nextMessageTimestampMsBefore:i.of_string(F),referenceTimestamp:h!=null?(i||(i=d("I64"))).to_string(h):void 0,requestId:B,taskSource:(j||(j=d("LSIntEnum"))).ofNumber((H=z)!=null?H:c("LSMEBTaskCreationSource").UNKNOWN),threadId:A}}]}))}}else{d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypt_messages_protobuf_start",traceId:B});c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START,{instanceKey:C});E=(yield e.runInTransaction(function(a){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:A,encryptedMessagesWithProtobufs:c("LSVec").ofArray(M)})},"readwrite"));K=E[0];H=E[1];if(H!=null){e=d("LSShape").toRecord(H);d("WALogger").ERROR(m());d("WALogger").WARN(l(),e.error_message);c("QPLUserFlow").endFailure(D,"PROTOBUF_DECRYPTION_FAILURE",{annotations:{string:{error_description:e.error_message}},instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!1,"PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:e.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypt_messages_protobuf_end",traceId:B});c("QPLUserFlow").addPoint(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END,{instanceKey:C});if(K!=null){E=d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(K);c("promiseDone")(d("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:f,decryptedMessagesProtobufs:E,hasMoreAfter:g,hasMoreBefore:I,isPointQuery:!0,nextMessageTimestampMsAfter:(i||(i=d("I64"))).of_string(G),nextMessageTimestampMsBefore:i.of_string(F),referenceTimestamp:h!=null?(i||(i=d("I64"))).to_string(h):void 0,requestId:B,taskSource:(j||(j=d("LSIntEnum"))).ofNumber((H=z)!=null?H:c("LSMEBTaskCreationSource").UNKNOWN),threadId:A}}]}))}else{c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPTED_PROTOBUFS_NULL,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPTED_PROTOBUFS_NULL}},instanceKey:C});d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypted_protobufs_null",traceId:B});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"decrypted_protobufs_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}}c("QPLUserFlow").endSuccess(D,{annotations:{bool:{isEcho:M.length===0,isProtobuf:M.length>0}},instanceKey:C});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.success");return d("WAResultOrError").makeResult()}catch(b){d("WALogger").ERROR(k(),b);c("QPLUserFlow").endFailure(D,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,errorStackTrace:(a=b.stack)!=null?a:""}},error:b,instanceKey:C});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(B,!0,"gql_point_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("runtime-error",b)}});return z.apply(this,arguments)}g.pointRestoreQuery=y;g.messagePointQueryWithPersistence=a}),98);
__d("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="9305752246212228"}),null);
__d("EBMessageRangeQueryWithPersistenceQuery.graphql",["EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"),metadata:{},name:"EBMessageRangeQueryWithPersistenceQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EchoMessageDecryptor",["CryptoUtils","I64","LSAuthorityLevel","LSIntEnum","MEBEncryptionVersion","Promise","ReQL","WACryptoUtils","WALogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No backup id provided"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Empty echo message string - cannot decrypt"]);n=function(){return a};return a}function o(a,b,c){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){if(b==null){d("WALogger").ERROR(k());return[]}a=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_epochs)));return a.filter(function(a){return(i||(i=d("I64"))).equal(a.authorityLevel,(j||(j=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))&&(i||(i=d("I64"))).equal(a.backupId,(i||(i=d("I64"))).of_float(b))&&e.equals(a[e.key])})});return p.apply(this,arguments)}function q(a,b){var c=b.epoch_id;return c!=null?o(a,b.backup_id,{equals:function(a){return a instanceof ArrayBuffer?!1:(i||(i=d("I64"))).equal(c,a)},key:"epochId",value:c}):o(a,b.backup_id,{equals:function(a){return a instanceof ArrayBuffer?d("WACryptoUtils").arrayBuffersEqual(b.epoch_anon_id,a):!1},key:"epochAnonIdBlob",value:b.epoch_anon_id})}a=function(){function a(){}var e=a.prototype;e.decrypt=function(a,e,f){f=f.map(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){if(b.value==null){d("WALogger").ERROR(n());return{otid:b.otid,value:null}}var f=b.value,g=(yield q(a,b));if(g.length===0){d("WALogger").ERROR(m());return{otid:b.otid,value:null}}g=(yield d("CryptoUtils").deriveMessageSymmetricKey(g[0].epochAnonIdBlob,g[0].epochRootKeyBlob,(g=b.encryption_version)!=null?g:c("MEBEncryptionVersion").UNKNOWN,e));if(g==null||g.length===0){d("WALogger").ERROR(l());return{otid:b.otid,value:null}}g=(yield d("CryptoUtils").symmetricEncryptionCreateDecryptedString(g[0],new TextEncoder().encode([d("CryptoUtils").MESSAGE_ENCYPTION_AAD,e].join(d("CryptoUtils").STRING_JOIN_SEPARATOR)).buffer,f));return{otid:b.otid,value:g}});return function(a){return f.apply(this,arguments)}}());return(h||(h=b("Promise"))).all(f)};return a}();g.getEpochKeysByID=q;g.EchoMessageDecryptor=a}),98);
__d("EBMessageRangeQueryWithPersistence",["Base64Utils","DeriveAndStoreEpochs","EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBMessageRangeQueryWithPersistenceQuery.graphql","EchoMessageDecryptor","I64","LSDatabaseSingleton","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSDeleteAndReenrollDeviceStateStoredProcedure","LSEncryptedBackupsMessagesRangeQueryDirection","LSFactory","LSIntEnum","LSMEBDeviceReenrollmentReason","LSMEBTaskCreationSource","LSShape","LSVec","MAWCurrentUser","MAWEBRestoreTrackingUtils","MAWJobDefinitions","MAWMiActGetThreadLifecycleState","MAWMiActThreadLifecycleState","QPLUserFlow","WAHashStringToNumber","WAJids","WAResultOrError","WATagsLogger","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","gkx","handleRestoreMessagesGraphQLResponse","justknobx","promiseDone","qex","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["graphQL range restore error ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with an error"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with error: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with an error."]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with error: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with an error."]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with error: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with an error."]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] messageRangeQuery echo: "," protobuf: "," nonLsEcho: "," nonLSProtobuf: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["message range info is not complete - cannot proceed with graphQL restore"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["backup_id is null during graphQL restore"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["message range info is null - cannot proceed with graphQL restore"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["server side exception during graphql restore - ",""]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] messageRangeQuery graphQL response messages: ",""]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["GQL worker range restore query returned null for message response"]);A=function(){return a};return a}function aa(){var a=babelHelpers.taggedTemplateLiteralLoose(["mandatory params of client state are null"]);aa=function(){return a};return a}function ba(){var a=babelHelpers.taggedTemplateLiteralLoose(["No client state found - unable to restore"]);ba=function(){return a};return a}function ca(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Issuing messageRangeQuery with args: ",""]);ca=function(){return a};return a}var da=c("requireDeferred")("LSEBUnifiedRestoreUtils").__setRef("EBMessageRangeQueryWithPersistence"),ea=c("requireDeferred")("LSRestoreEchoBlobs.nop").__setRef("EBMessageRangeQueryWithPersistence"),fa=c("requireDeferred")("LSRestoreProtobufs.nop").__setRef("EBMessageRangeQueryWithPersistence"),B=d("WATagsLogger").TAGS(["labyrinth_web","EBMessageRangeQueryWithPersistence"]),ga=h!==void 0?h:h=b("EBMessageRangeQueryWithPersistenceQuery.graphql");function a(a){return C.apply(this,arguments)}function C(){C=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.chatJid,g=a.direction,h=a.includeOffset;h=h===void 0?!1:h;var C=a.numMessages,D=a.sortOrderMs,E=a.source,F=a.traceId;if(d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");var G=c("qex")._("3429")||c("gkx")("11008");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql");var H=d("WAHashStringToNumber").hashStringToNumber(F),I=c("qpl")._(521471755,"2586");try{var J,K;c("QPLUserFlow").start(I,{annotations:{bool:{mainThreadRestore:!0,workerThreadRestore:!1},"int":{num_messages_requested:C,source:(J=E)!=null?J:c("LSMEBTaskCreationSource").UNKNOWN},string:{request_args:JSON.stringify(a)}},instanceKey:H,timeoutInMs:c("justknobx")._("2950")});B.LOG(ca(),F,JSON.stringify(a));d("MAWEBRestoreTrackingUtils").markEBRestorePaginated(E,F,"GQL_MAIN_THREAD");var L=(yield (i||(i=d("LSDatabaseSingleton"))).getLSDatabaseSingletonPromiseOrValue());d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"lsdb_singleton_retrieved",traceId:F,type:"none"});c("QPLUserFlow").addPoint(I,"lsdb_singleton_retrieved",{instanceKey:H});var M;yield L.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;M=(yield d("handleRestoreMessagesGraphQLResponse").getClientState(L,a));d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{device_id:(j||(j=d("I64"))).to_string((b=(b=M)==null?void 0:b.device_id)!=null?b:(j||(j=d("I64"))).zero)}},pointName:"client_state_retrieved",traceId:F});c("QPLUserFlow").addPoint(I,"client_state_retrieved",{data:{string:{device_id:j.to_string((b=(b=M)==null?void 0:b.device_id)!=null?b:(j||(j=d("I64"))).zero)}},instanceKey:H});b=(yield d("MAWMiActGetThreadLifecycleState").getThreadLifecycleStateByJid(a,j.of_string(d("WAJids").threadIdForChatJid(e)),"GQL_range_restore_eb_api_call"));if(b.type===d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MAPPING_ROW||b.type===d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MI_THREAD){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:b.type}},pointName:"chat_jid_not_found_in_act_mapping_table",traceId:F});c("QPLUserFlow").addPoint(I,"chat_jid_not_found_in_act_mapping_table",{instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(F,!1);c("QPLUserFlow").endSuccess(I,{instanceKey:H});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.thread.missing.error");return d("WAResultOrError").makeError("thread-not-found-in-mi-act-mapping-table")}else d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:b.type}},pointName:"chat_jid_exists_in_act_mapping_table",traceId:F}),c("QPLUserFlow").addPoint(I,"chat_jid_exists_in_act_mapping_table",{instanceKey:H})});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":201");if(M==null){B.ERROR(ba());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("no-client-state")}J=M;a=J.backupId;var N=J.device_id,O=J.locally_available_epochs,P=J.mailboxRootKey;J=J.ocmfClientStateBlob;if(a==null||N==null||P==null||J==null){B.ERROR(aa());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"client_state_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}var Q=d("MAWCurrentUser").getAppID();d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"app_id_retrieved",traceId:F,type:"none"});c("QPLUserFlow").addPoint(I,"app_id_retrieved",{instanceKey:H});var R=d("WAJids").threadIdForChatJid(e);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"converted_chatjid_to_threadid",traceId:F,type:"none"});c("QPLUserFlow").addPoint(I,"converted_chatjid_to_threadid",{instanceKey:H});g=g==="before"?c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE:c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER;O={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(R),site:"www",tam_thread_subtype:0},success:babelHelpers["extends"]({device_context:{device_id:(j||(j=d("I64"))).to_string(N),locally_available_epochs:O,raw_tokens:{mailbox_root_key:d("Base64Utils").fromArrayBuffer(P),ocmf_client_state_blob:d("Base64Utils").fromArrayBuffer(J)}},direction:g,include_offset:h,query_num_messages:C,server_thread_key:R},D!=null?{reference_timestamp:D}:{})};c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START,{instanceKey:H});d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_start",traceId:F,type:"none"});var S;try{yield d("WorkerRelayNetwork").createWorkerNetworkExecute();S=(yield d("WorkerRelay").createWorkerQuery(ga,{app_id:String((P=Q)!=null?P:"0"),restore_payload_string:JSON.stringify(O),restore_type:"RANGE_QUERY_RESTORE"}));c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END,{instanceKey:H});d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_end",traceId:F,type:"none"})}catch(a){c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,errorStackTrace:(J=a.stack)!=null?J:""}},instanceKey:H});return d("WAResultOrError").makeError("invalid-graphql-response")}if(S==null||((g=S)==null?void 0:(h=g.viewer)==null?void 0:(C=h.encrypted_backup)==null?void 0:C.mailbox)==null){c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}g=(Q=S)==null?void 0:(P=Q.viewer)==null?void 0:(O=P.encrypted_backup)==null?void 0:(J=O.mailbox)==null?void 0:J.messages;if(g==null){B.ERROR(A());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}h=g;if((h==null?void 0:h.encrypted_messages)==null){c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"null_messages");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}C=h.backup_id;Q=h.encrypted_messages;P=h.epoch_derivation_set;O=h.exception_string;J=h.message_range_info;g=h.should_delete_mailbox;var T=h.thread_not_found;c("QPLUserFlow").addAnnotations(I,{bool:{should_delete_mailbox:(K=g)!=null?K:!1},"int":{response_messages:Q.length},string:{message_range_info:JSON.stringify(J)}},{instanceKey:H});B.LOG(z(),F,JSON.stringify(h));if(O!=null){B.ERROR(y(),O);if(T!=null&&T){c("QPLUserFlow").addPoint(I,"thread_not_found_on_server",{instanceKey:H});d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"thread_not_found_on_server",traceId:F,type:"none"});c("QPLUserFlow").endSuccess(I,{instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(F,!1);return d("WAResultOrError").makeError("thread-not-found-on-server")}g===!0&&(c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX,{instanceKey:H}),yield L.runInTransaction(function(a){return c("LSDeleteAndReenrollDeviceStateStoredProcedure")(c("LSFactory")(a),{reenrollmentReason:(k||(k=d("LSIntEnum"))).ofNumber(c("LSMEBDeviceReenrollmentReason").RESTORE_FAILED_WITH_NO_DEVICE_FOUND),targetDeviceId:N})},"readwrite",void 0,void 0,f.id+":567"),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"delete_mailbox",traceId:F,type:"none"}));c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:O}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{exception:O}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("server-side-exception")}c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START,{instanceKey:H});c("gkx")("11617")?yield d("DeriveAndStoreEpochs").deriveAndStoreEpochs(L,P):yield d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(P,L,N,F);c("QPLUserFlow").addAnnotations(I,{bool:{hasEpochs:P!=null&&P.epoch_edges.length>0}},{instanceKey:H});c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END,{instanceKey:H});Q.length===0&&(c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_MESSAGES_TO_RESTORE,{instanceKey:H}),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"no_messages",traceId:F,type:"none"}));if(J==null){B.ERROR(x());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}C==null&&(B.WARN(w()),c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL,{instanceKey:H}),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"backup_id_null",traceId:F,type:"none"}));var U=J.has_more_after,V=J.has_more_before,W=J.next_message_timestamp_ms_after,X=J.next_message_timestamp_ms_before;if(V==null||U==null||W==null||X==null){B.ERROR(v());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"message_range_info_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}K=d("handleRestoreMessagesGraphQLResponse").processMessageArray(Q,C!=null?C:(j||(j=d("I64"))).to_string(a),I,H);var Y=K.encryptedLSEchoMessages,Z=K.encryptedMessagesWithProtobufs;h=K.encryptedNonLSEchoMessages;T=K.encryptedNonLSProtobufs;B.LOG(u(),F,Y.length,Z.length,h.length,T.length);g="none";if(Y.length>0&&Z.length>0){g="mixed";c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RESTORING_MIXED_ECHO_PROTOBUF_PAYLOAD,{instanceKey:H});Q.length!==Y.length+Z.length&&c("QPLUserFlow").addPoint(I,"mixed_restore_payload_echo_and_protobuf_count_mismatch",{instanceKey:H});c("QPLUserFlow").addAnnotations(I,{"int":{echoMessagesPayloadSize:Y.length,protobufMessagesPayloadSize:Z.length,totalRestorePayloadSize:Y.length+Z.length}},{instanceKey:H});c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_START,{instanceKey:H});O=(yield L.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:R,encryptedMessages:c("LSVec").ofArray(Y)})),e=b[0];b=b[1];if(b!=null){b=d("LSShape").toRecord(b);B.ERROR(t());B.WARN(s(),b.error_message);c("QPLUserFlow").endFailure(I,"ECHO_DECRYPTION_FAILURE",{annotations:{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:b.error_message}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"ECHO_DECRYPTION_FAILURE",{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:b.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("echo-decryption-failure")}b=(yield c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:R,encryptedMessagesWithProtobufs:c("LSVec").ofArray(Z)}));a=b[0];b=b[1];if(b!=null){b=d("LSShape").toRecord(b);B.ERROR(r());B.WARN(q(),b.error_message);c("QPLUserFlow").endFailure(I,"PROTOBUF_DECRYPTION_FAILURE",{annotations:{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:b.error_message}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"PROTOBUF_DECRYPTION_FAILURE",{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:b.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}return{decryptedEchoMsgs:e,decryptedProtobufMsgs:a}});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":808"));P=O.decryptedEchoMsgs;var ia=O.decryptedProtobufMsgs;c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_END,{instanceKey:H});var $;P!=null&&($=c("LSVec").toArray(P).map(function(a){return d("LSShape").toRecord(a).value}));if(c("gkx")("9385")){yield ha((J=$)!=null?J:[],h,R,L,F,H)}c("promiseDone")(da.load().then(function(a){return a.echoProtobufConsolidatedRestoreHelper(R,(a=ia)!=null?a:c("LSVec").ofArray([]),V,(j||(j=d("I64"))).of_string(X),U,j.of_string(W),!1,F,D,void 0,c("LSVec").ofArray($),(k||(k=d("LSIntEnum"))).ofNumber((a=E)!=null?a:c("LSMEBTaskCreationSource").UNKNOWN),e,!0)}))}else if(Z.length===0){g="echo";c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START,{instanceKey:H});C=(yield L.runInTransaction(function(a){return c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:R,encryptedMessages:c("LSVec").ofArray(Y)})},"readwrite",void 0,void 0,f.id+":955"));a=C[0];K=C[1];if(K!=null){T=d("LSShape").toRecord(K);B.ERROR(p());B.WARN(o(),T.error_message);c("QPLUserFlow").endFailure(I,"ECHO_DECRYPTION_FAILURE",{annotations:{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:T.error_message}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"ECHO_DECRYPTION_FAILURE",{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:T.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("echo-decryption-failure")}c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END,{instanceKey:H});if(a!=null){var ja=c("LSVec").toArray(a).map(function(a){return d("LSShape").toRecord(a).value});if(c("gkx")("9385")){yield ha((Q=ja)!=null?Q:[],h,R,L,F,H)}c("promiseDone")(ea.load().then(function(a){return L.runInTransaction(function(b){return a(b,0,(j||(j=d("I64"))).zero,c("LSVec").ofArray(ja),V,j.of_string(X),U,j.of_string(W),!1,R,F,D,(k||(k=d("LSIntEnum"))).ofNumber((b=E)!=null?b:c("LSMEBTaskCreationSource").UNKNOWN),e)},"readwrite",void 0,void 0,f.id+":1024")}))}}else{g="protobuf";c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START,{instanceKey:H});O=(yield L.runInTransaction(function(a){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:R,encryptedMessagesWithProtobufs:c("LSVec").ofArray(Z)})},"readwrite",void 0,void 0,f.id+":1057"));var ka=O[0];P=O[1];if(P!=null){J=d("LSShape").toRecord(P);B.ERROR(n());B.WARN(m(),J.error_message);c("QPLUserFlow").endFailure(I,"PROTOBUF_DECRYPTION_FAILURE",{annotations:{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:J.error_message}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"PROTOBUF_DECRYPTION_FAILURE",{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:J.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END,{instanceKey:H});c("promiseDone")(fa.load().then(function(a){return L.runInTransaction(function(b){return a(b,0,R,(b=ka)!=null?b:c("LSVec").ofArray([]),V,(j||(j=d("I64"))).of_string(X),U,j.of_string(W),!1,F,D,void 0,c("LSVec").ofArray([]),(k||(k=d("LSIntEnum"))).ofNumber((b=E)!=null?b:c("LSMEBTaskCreationSource").UNKNOWN),e)},"readwrite",void 0,void 0,f.id+":1109")}))}c("QPLUserFlow").endSuccess(I,{annotations:{string:{restoreType:g}},instanceKey:H});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult()}catch(a){B.ERROR(l(),a);c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,errorStackTrace:(C=a.stack)!=null?C:""}},error:a,instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("runtime-error",a)}});return C.apply(this,arguments)}function ha(a,b,c,d,e,f){return D.apply(this,arguments)}function D(){D=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h){var i=c("qpl")._(521471755,"2586");f=(yield new(d("EchoMessageDecryptor").EchoMessageDecryptor)().decrypt(f,e,b));e=E(f,a);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{bool:{isMatch:e}},pointName:"ls_and_non_ls_echo_msg_decryption_response_comparison",traceId:g});c("QPLUserFlow").addAnnotations(i,{bool:{does_ls_and_non_ls_echo_msg_decryption_match:e}},{instanceKey:h})});return D.apply(this,arguments)}function E(a,b){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c].value!==b[c])return!1;return!0}g.query=ga;g.messageRangeQueryWithPersistence=a}),98);
__d("EncryptedBackupUploadFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5728");b=d("FalcoLoggerInternal").create("encrypted_backup_upload_failure",a);e=b;g["default"]=e}),98);
__d("EncryptedBackupUploadSuccessFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5729");b=d("FalcoLoggerInternal").create("encrypted_backup_upload_success",a);e=b;g["default"]=e}),98);
__d("LsDataTraceFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("1743851");b=d("FalcoLoggerInternal").create("ls_data_trace",a);e=b;g["default"]=e}),98);
__d("LSDataTraceFlush",["ArmadilloDataTraceType","I64","LSDataTraceType","LSIntEnum","LsDataTraceFalcoEvent","ODS","Promise","ReQL","asyncToGeneratorRuntime","clearTimeout","gkx","promiseDone","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=(i||(i=d("I64"))).of_string("120000"),m=i.of_string("600000"),n=new Set(["encrypted_backups_upload","encrypted_backups_media_backup"]);function o(a,b,c){var e=a.length;if(e===0)return[(i||(i=d("I64"))).neg_one,i.neg_one,void 0,void 0,void 0];e=a.find(function(a){return a.errorMessage!=null});e=e==null?void 0:e.errorMessage;a=a[a.length-1|0];var f=(i||(i=d("I64"))).of_float(Date.now()),g=a.timestampMs,h=i.compare(i.sub(f,c),l)>=0;return!b&&h?[(i||(i=d("I64"))).sub(f,c),a.checkPointId,g,e,"trace expired"]:[i.sub(g,c),a.checkPointId,g,e,e]}function p(a){return a.reduce(function(a,b,c){var e,f=(i||(i=d("I64"))).to_string(b.checkPointId),g=b.timestampMs;e=i.to_string((e=b.syncChannel)!=null?e:(i||(i=d("I64"))).neg_one);b=b.tags;b=b!=null?","+b:"";if(c===0)a.pointsList="".concat("(",f,",",e,b,")");else{c=String((i||(i=d("I64"))).to_int32(i.sub(g,a.lastCheckPointTimestamp)));a.pointsList=a.pointsList.concat("-",c,"-(",f,",",e,b,")")}a.lastCheckPointTimestamp=g;return a},{lastCheckPointTimestamp:(i||(i=d("I64"))).zero,pointsList:""}).pointsList}var q=i.of_string("2");function r(a){var b=a.traceType;b=(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").TASK))?"send":(i||(i=d("I64"))).equal(b,d("ArmadilloDataTraceType").armadilloMessageSend)?"armadillo send":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_UPLOAD))?"encrypted_backups_upload":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_RESTORE))?"encrypted_backups_restore":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_MEDIA_BACKUP))?"encrypted_backups_media_backup":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").SAP_VESTA_LOGIN))?"sap_vesta_login":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").SAP_VESTA_REGISTRATION))?"sap_vesta_registration":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_MEDIA_RESTORE))?"encrypted_backups_media_restore":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_INIT))?"shadow_encrypted_backups_init":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_ADD_DEVICE))?"shadow_encrypted_backups_add_device":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_UPLOAD))?"shadow_encrypted_backups_upload":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_RESTORE))?"shadow_encrypted_backups_restore":(i||(i=d("I64"))).equal(b,(k||(k=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_SHADOW_DELETE_BACKUP))?"shadow_encrypted_backups_delete_backup":a.contextTwo;return b}function s(a,b){var e=b.traceId,f=b.shouldFlush,g=r(b),h=b.traceType,j=(i||(i=d("I64"))).equal(h,d("ArmadilloDataTraceType").armadilloMessageSend)?"tam_message_send":b.contextOne,k=(i||(i=d("I64"))).equal(b.traceType,q)?void 0:b.predefinedId,l=b.initTimestampMs;return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.data_trace_addon.index("traceIdAddonId")).getKeyRange(e)).then(function(a){var b=o(a,f,l),h=b[0],m=b[1],n=b[3],q=b[4],r=a.length,s=p(a);c("LsDataTraceFalcoEvent").log(function(){var a;return{check_point_count:(i||(i=d("I64"))).to_string(i.of_int32(r)),check_point_list:s,client_event_ts:i.to_string(i.of_float(Date.now())),cold_start_time:void 0,data_trace_id:e,database_id:j,delivered_messages:void 0,error_message:q,first_error_message:n,has_backgrounded:!1,last_check_point:i.to_string(m),latency:i.to_string(h),media_type:void 0,num_of_attachments:void 0,persisted_metadata:void 0,predefined_id:k,sent_rich_media_messages:void 0,sent_text_messages:void 0,start_time:i.to_string(l),trace_flow:(a=g)!=null?a:""}})}).then(function(){return a.data_trace_meta["delete"](e)})}function a(a,c){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.data_trace_meta).getKeyRange(c)).then(function(c){if(c!=null)return s(a,c);else return(h||(h=b("Promise"))).resolve()})}var t={contents:void 0};function u(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.data_trace_meta.index("shouldFlushInitTimestampMsTraceId")).getKeyRange(!1).bounds({lt:d("ReQL").key((i||(i=d("I64"))).sub(i.of_float(Date.now()),l))})).then(function(a){if(c("gkx")("23914")){var b=(i||(i=d("I64"))).of_float(Date.now());return a.filter(function(a){var c=r(a);if(c!=null&&n.has(c)){c=(i||(i=d("I64"))).compare(i.sub(b,a.initTimestampMs),m)>=0;return c}return!0})}return a})}function v(a){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=(yield u(a.tables));if(c.length===0)return;return a.runInTransaction(function(a){return u(a).then(function(c){return(h||(h=b("Promise"))).all(c.map(function(b){return s(a,b)}))})},"readwrite",void 0,void 0,f.id+":312")});return w.apply(this,arguments)}function x(){var a=t.contents;if(a!=null){c("clearTimeout")(a);return}}function y(a){c("promiseDone")(v(a),function(){x();var b=c("setTimeout")(function(){y(a)},6e4);t.contents=b},function(){x(),(j||(j=d("ODS"))).bumpEntityKey(3185,"mw_trace","error")});return x}e=a;a=y;e={flush:e,flushExpiredDataTraces:a};g["default"]=e}),98);
__d("LSRestoreEchoBlobsHandler",["LSRestoreProtobufs.nop","LSVec","MAWBridgeSafeActionsWorkerAndUI","MAWEBRestoreTrackingUtils","MAWEncryptedBackupUtils","MAWJobDefinitions","Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,d,e,f,g,h,j,k,l,m,n){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,i,j,k,l,m,n,o,p,q){var r=c("LSVec").toArray(f).map(d("MAWJobDefinitions").toEncodedEchoMessage);n!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"echo_to_protobuf_conversion_start",traceId:n,type:"echo"});r=(yield d("MAWBridgeSafeActionsWorkerAndUI").sendAndReceiveBackendWorkerAndUIShared("convertEchoMessagesToEBProtobufs",{chatJid:q,encodedEchoMessages:r}));n!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"echo_to_protobuf_conversion_success",traceId:n,type:"echo"});yield c("LSRestoreProtobufs.nop")(a,e,m,d("MAWEncryptedBackupUtils").convertJSTypesToLSTypesForRestoreJob(r),g,i,j,k,l,n,o,"",f,p,q);return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])])});return i.apply(this,arguments)}g.handleEchoBlobsRestore=a}),98);
__d("LSRestoreEchoBlobs.nop",["LSRestoreEchoBlobsHandler","LSVec","MAWAsyncEBPendingQueryPromise","MAWEBRestoreTrackingUtils","MAWThreadIdToChatJidMapping","Promise","WAJids","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,i,j,k,l,m,n,o,p,q,r){var s;r!=null&&(s=d("WAJids").validateChatJid(r));s==null&&(s=(yield d("MAWThreadIdToChatJidMapping").genChatJidFromThreadId(a,n,"LSRestoreEchoBlobs.nop")));if(s==null){o!=null&&d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(o,c("err")("Cannot generate ChatJid from threadKey: "+n));d("MAWEBRestoreTrackingUtils").markEBRestoreFail(o,!1,"no_chat_jid");return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])])}return d("LSRestoreEchoBlobsHandler").handleEchoBlobsRestore(a,e,g,i,j,k,l,m,n,o,p,q,s)});function e(b,c,d,e,f,g,h,i,j,k,l,m,n,o){return a.apply(this,arguments)}return e}();a.__nop_name__="LSRestoreEchoBlobs";g["default"]=a}),98);
__d("LogWebQplNOP",["I64","LSIntEnum","Promise","QPLUserFlow","WAHashStringToNumber","WALogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["LSLogWebQpl error: ",""]);k=function(){return a};return a}function l(a){a=a==null?null:(j||(j=d("I64"))).to_int32(a);switch(a){case 521476165:return c("qpl")._(521476165,"2432");case 521481602:return c("qpl")._(521481602,"829");default:return null}}function a(a,e,f,g,m,n){return new(h||(h=b("Promise")))(function(b,h){try{h=m?(i||(i=d("LSIntEnum"))).unwrapIntEnum(m):null;var o=l(e);if(o!=null&&f!=null){h={"int":{num_messages:(j||(j=d("I64"))).to_int32(g)},string:{message_count:String(g),taskSource:(h=h==null?void 0:h.toString())!=null?h:"unknown"}};n===!0?c("QPLUserFlow").endSuccess(o,{annotations:h,instanceKey:d("WAHashStringToNumber").hashStringToNumber(a)}):n===!1?c("QPLUserFlow").endFailure(o,f,{annotations:h,instanceKey:d("WAHashStringToNumber").hashStringToNumber(a)}):(c("QPLUserFlow").addAnnotations(o,h,{instanceKey:d("WAHashStringToNumber").hashStringToNumber(a)}),c("QPLUserFlow").addPoint(o,f,{instanceKey:d("WAHashStringToNumber").hashStringToNumber(a)}))}b()}catch(a){d("WALogger").ERROR(k(),a),b()}})}g.call=a}),98);
__d("X25519",["$InternalEnum","Promise","WACryptoCurve25519Dependencies","WASignalKeys","WASignalOther","WASignalSignatures"],(function(a,b,c,d,e,f,g){"use strict";var h,i=b("$InternalEnum").Mirrored(["Encryption","Signing"]),j=b("$InternalEnum")({PublicKey:0,PrivateKey:1,Signature:2});function k(a,b){if(b===i.Encryption)return[];b=1;switch(a){case j.PublicKey:b=1;break;case j.PrivateKey:b=2;break;case j.Signature:b=3;break}return[255,b]}function l(a,b,c){b=k(b,c);c=b.length;if(c<=0)return a;var d=new Uint8Array(c+a.byteLength);d.set(Array.from(b));d.set(a,c);return d}function m(a,b,c){b=k(b,c).length;return a.slice(b)}function n(a,b){return{privateKey:l(a.privateKey,j.PrivateKey,b),publicKey:l(a.publicKey,j.PublicKey,b)}}function a(a){a=n(d("WASignalKeys").makeKeyPair(),a);return{pk:a.publicKey,sk:a.privateKey}}function o(a,b){if(b===i.Encryption)return 32;switch(a){case j.PublicKey:case j.PrivateKey:return 32;case j.Signature:return 64}}function p(a,b,c){var d=k(b,c),e=d.length;b=o(b,c);c=b!=null?e+b:0;if(a.length!==c)return!1;var f=a.subarray(0,e);b=new Uint8Array(d);return b.length===f.length&&b.every(function(a,b){return a===f[b]})}function q(a,b){if(p(a,j.PublicKey,b))return a;return}function r(a,b){if(p(a,j.PrivateKey,b))return a;return}function c(a,b){var c=q(a.pkBytes,b);a=r(a.skBytes,b);if(c!=null&&a!=null)return{pk:c,sk:a}}function e(a,c){a=m(a,j.PrivateKey,i.Signing);return d("WASignalSignatures").signMsg(d("WASignalKeys").makeKeyPairFrom(d("WASignalOther").ensureSize(a,32)),c).then(function(a){a=l(a,j.Signature,i.Signing);return(h||(h=b("Promise"))).resolve(a)})}function f(a){if(p(a,j.Signature,i.Signing))return a}function s(a,b,c){b=m(b,j.PublicKey,i.Signing);return d("WASignalSignatures").verifyMsgSignalVariant(d("WASignalKeys").serializeIdentity(b),c,d("WASignalOther").ensureSize(m(a,j.Signature,i.Signing),64))}function t(a,c){c=c;a=a;return!p(a,j.PublicKey,i.Encryption)||!p(c,j.PrivateKey,i.Encryption)?(h||(h=b("Promise"))).resolve():d("WACryptoCurve25519Dependencies").calculateAgreement(a,c).then(function(a){return(h||(h=b("Promise"))).resolve(new Uint8Array(a))})}g.KeyPurpose=i;g.generateKeys=a;g.publicKeyFromBytes=q;g.secretKeyFromBytes=r;g.keysFromBytes=c;g.sign=e;g.signatureFromBytes=f;g.verify=s;g.exchangeKeys=t}),98);
__d("PublicKeyCrypto",["Promise","UInt8Array","X25519"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,c){return(h||(h=b("Promise"))).all([a,c]).then(function(a){return(h||(h=b("Promise"))).resolve(a[0]!=null&&a[1]!=null?d("UInt8Array").concatBytes([a[0],a[1]]):void 0)})}function a(a,b,c){return i(d("X25519").exchangeKeys(c,a),d("X25519").exchangeKeys(c,b))}function c(a,b,c){return i(d("X25519").exchangeKeys(c,a),d("X25519").exchangeKeys(b,a))}g.senderDeriveSharedSecret=a;g.receiverDeriveSharedSecret=c}),98);
/**
 * License: https://www.facebook.com/legal/license/ZMc_bSwzLKC/
 */
__d("ristretto255-0.1.1",["tweetnacl-1.0.3"],(function(a,b,c,d,e,f,g){var h=c("tweetnacl-1.0.3")();Uint8Array.prototype.slice||Object.defineProperty(Uint8Array.prototype,"slice",{value:function(a,b){return new Uint8Array(Array.prototype.slice.call(this,a,b))}});c={};var i=h.lowlevel,j=i.gf([1]);function k(){return[i.gf(),i.gf(),i.gf(),i.gf()]}var l=new Uint8Array([226,242,174,10,106,188,78,113,168,132,169,97,197,0,81,95,88,227,11,106,165,130,221,141,182,166,89,69,224,141,45,118]),m=new Float64Array([235,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function n(a,b,c){var d=new Float64Array(64);for(var e=0;e<32;e++)for(var f=0;f<32;f++)d[e+f]+=b[e]*c[f];i.modL(a,d)}function o(a,b){n(a,b,b)}function p(a,b){for(var c=0;c<32;c++)a[c]=b[c];for(c=251;c>=0;c--)o(a,a),(m[c>>3]>>(c&7)&1)!==0&&n(a,a,b)}var q=i.gf([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]),r=i.gf([11803,18811,63136,32407,21693,7032,36364,44957,53757,12789,64713,3900,18604,11139,12735,14185]),s=i.gf([16618,32861,64938,39368,29374,23105,5655,40239,55360,65025,31633,5826,64674,53167,35077,30828]),t=i.gf([49526,37983,2497,57980,13583,52574,41272,11393,57316,48752,43997,39316,57559,45747,29352,656]),u=i.gf([19744,17645,23210,12717,6553,45086,18988,53918,20203,21147,54063,19676,8769,63084,45946,22888]);function v(a){var b=new Uint8Array(32);i.pack25519(b,a);a=1;for(var c=0;c<32;c++)a&=b[c]===0;return a}function w(a,b,c){var d;c=-c;for(var e=0;e<16;e++)d=a[e]^b[e],d&=c,a[e]^=d}function x(a){var b=new Uint8Array(32);i.pack25519(b,a);return b[0]&1}function y(a,b){i.Z(a,i.gf(),b)}function z(a,b,c){var d=i.gf();y(d,b);i.set25519(a,b);w(a,d,c)}function A(a,b){z(a,b,x(b))}function B(a,b,c){var d=i.gf(),e=i.gf(),f=i.gf(),g=i.gf(),h=i.gf(),j=i.gf();i.S(d,c);i.M(d,d,c);i.S(a,d);i.M(a,a,c);i.M(a,a,b);i.pow2523(a,a);i.M(a,a,d);i.M(a,a,b);i.S(e,a);i.M(e,e,c);i.Z(f,e,b);i.A(g,e,b);i.M(h,b,q);i.A(h,e,h);d=v(f);c=v(g);b=v(h);i.M(j,a,q);w(a,j,c|b);A(a,a);return d|c}function C(a){var b=i.gf(),c=i.gf(),d=i.gf(),e=i.gf(),f=i.gf(),g=i.gf(),h=i.gf(),k=i.gf(),l=i.gf(),m=i.gf(),n=i.gf(),o=i.gf(),p=i.gf(),r=i.gf(),t=i.gf(),u=i.gf(),v=i.gf(),y=0,C=new Uint8Array(32);i.A(m,a[2],a[1]);i.Z(v,a[2],a[1]);i.M(m,m,v);i.M(n,a[0],a[1]);i.S(o,n);i.M(o,m,o);B(f,j,o);i.M(b,f,m);i.M(c,f,n);i.M(u,b,c);i.M(u,u,a[3]);i.M(g,a[0],q);i.M(h,a[1],q);i.M(e,b,s);i.M(l,a[3],u);y=x(l);p=i.gf(a[0]);r=i.gf(a[1]);d=i.gf(c);w(p,h,y);w(r,g,y);w(d,e,y);i.M(t,p,u);z(r,r,x(t));i.Z(k,a[2],r);i.M(k,d,k);A(k,k);i.pack25519(C,k);return C}function D(a){var b=a[31]&127^127;for(var c=30;c>0;c--)b|=a[c]^255;b=(b|0>>>0)-1>>8;c=237-1-(a[0]|0>>>0)>>8;return 1-((b&c|a[0])&1|(a[31]&255)>>7)}function E(a,b){var c=i.gf(),d=i.gf(),e=i.gf(),f=i.gf(),g=i.gf(),h=i.gf(),k=i.gf(),l=i.gf(),m=i.gf(),n=i.gf();if(D(b)===0)return-1;i.unpack25519(e,b);i.S(f,e);i.set25519(g,j);i.Z(g,g,f);i.S(k,g);i.set25519(h,j);i.A(h,h,f);i.S(l,h);i.M(m,i.D,k);y(m,m);i.Z(m,m,l);i.M(n,m,l);i.set25519(d,j);b=B(c,d,n);i.M(a[0],c,h);i.M(a[1],c,a[0]);i.M(a[1],a[1],m);i.M(a[0],a[0],e);i.A(a[0],a[0],a[0]);A(a[0],a[0]);i.M(a[1],g,a[1]);i.set25519(a[2],j);i.M(a[3],a[0],a[1]);return-(1-b|x(a[3])|v(a[1]))}function F(a,b){var c=i.gf(),d=i.gf(),e=i.gf(),f=i.gf(),g=i.gf(),h=i.gf(),k=i.gf(),l=i.gf(),m=i.gf(),n=i.gf(),o=i.gf(),p=i.gf(),s=i.gf(),v=i.gf();i.set25519(e,j);i.S(f,b);i.M(f,q,f);i.A(m,f,e);i.M(m,m,t);i.set25519(c,j);y(c,c);i.A(g,f,i.D);i.M(n,f,i.D);i.Z(n,c,n);i.M(n,n,g);g=1-B(h,m,n);i.M(k,h,b);A(k,k);y(k,k);w(h,k,g);w(c,f,g);i.Z(d,f,e);i.M(d,d,c);i.M(d,d,u);i.Z(d,d,n);i.A(o,h,h);i.M(o,o,n);i.M(p,d,r);i.S(l,h);i.Z(s,e,l);i.A(v,e,l);i.M(a[0],o,v);i.M(a[1],s,p);i.M(a[2],p,v);i.M(a[3],o,s)}function G(a){var b=i.gf(),c=i.gf(),d=k(),e=k();i.unpack25519(b,a.slice(0,32));i.unpack25519(c,a.slice(32,64));F(d,b);F(e,c);i.add(d,e);return d}function a(a){var b=k();i.scalarbase(b,a);return C(b)}function b(a,b){var c=k(),d=k();if(E(c,b)!==0)throw new Error("Invalid argument");i.scalarmult(d,c,a);return C(d)}function d(a){var b=k();return E(b,a)===-1?!1:!0}function H(a,b){var c=k(),d=k();if(E(c,a)===-1)throw new Error("Invalid argument");if(E(d,b)===-1)throw new Error("Invalid argument");return[c,d]}function e(a,b){a=H(a,b);b=a[0];a=a[1];i.add(b,a);return C(b)}function I(a,b){var c=i.gf();y(c,b[3]);var d=i.gf();y(d,b[0]);d=[d,b[1],b[2],c];i.add(a,d)}function g(a,b){a=H(a,b);b=a[0];a=a[1];I(b,a);return C(b)}function J(){var a=h.randomBytes(64);return G(a)}function K(a){return C(G(a))}function L(){return C(J())}function M(){var a;new Uint8Array(32);var b=0;do{a=h.randomBytes(32);a[31]&=31;var c=32,d=1;do c--,b|=a[c]-i.L[c]>>8&d,d&=(a[c]^i.L[c])-1>>8;while(c!==0)}while(b===0);return a}function N(a){var b=new Uint8Array(32);p(b,a);return b}function O(a){var b=new Float64Array(64);for(var c=0;c<32;c++)b[c]=-a[c];c=new Uint8Array(32);i.modL(c,b);return c}function P(a,b){var c=new Float64Array(64);for(var d=0;d<32;d++)c[d]=a[d]+b[d];d=new Uint8Array(32);i.modL(d,c);return d}function Q(a,b){return P(a,O(b))}function R(a,b){var c=new Uint8Array(32);n(c,a,b);return c}c.scalarMultBase=a;c.scalarMult=b;c.isValid=d;c.add=e;c.sub=g;c.fromHash=K;c.getRandom=L;c.basePoint=l;c.scalar={};c.scalar.getRandom=M;c.scalar.invert=N;c.scalar.negate=O;c.scalar.add=P;c.scalar.sub=Q;c.scalar.mul=R;c.unsafe={};c.unsafe.point={};c.unsafe.point.toBytes=C;c.unsafe.point.fromBytes=E;c.unsafe.point.fromHash=G;c.unsafe.point.sub=I;c.unsafe.point.add=i.add;c.unsafe.point.scalarMultBase=i.scalarbase;c.unsafe.point.scalarMult=i.scalarmult;c.unsafe.point.getRandom=J;c.unsafe.point.alloc=k;c.unsafe.constants={};c.unsafe.constants.LSub2=m;c.unsafe.constants.sqrtm1=q;c.unsafe.constants.sqrtadm1=r;c.unsafe.constants.invsqrtamd=s;c.unsafe.constants.onemsqd=t;c.unsafe.constants.sqdmone=u;f.exports=c}),34);
__d("ristretto255",["ristretto255-0.1.1"],(function(a,b,c,d,e,f){e.exports=b("ristretto255-0.1.1")}),null);