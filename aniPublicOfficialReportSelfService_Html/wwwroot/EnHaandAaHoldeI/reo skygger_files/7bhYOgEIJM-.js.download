;/*FB_PKG_DELIM*/

__d("MAWDeanonDataCheck",["gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d){if(!c("gkx")("8338")){var e=b;d||(e=b+1);return a.length>=e}if(a.length===0)return!1;var f=a[a.length-1].sortOrderMs;e=a.filter(function(a){return a.sortOrderMs===f});e=a.length-e.length;if(!d){var g=a[0].sortOrderMs;d=a.filter(function(a){return a.sortOrderMs===g});e-=d.length}return e>=b}g.hasEnoughDeanonData=a}),98);
__d("MAWFetchEBDeanonMessagesMetadata",["DateConsts","EBFormatUtils","FBLogger","I64","MAWEBDeanonFetch","MAWMessagesDirection","MAWMessagesPaginationUtils","Promise","WAResultOrError","asyncToGeneratorRuntime","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=100,k="timeout",l=10*d("DateConsts").MS_PER_SEC;function a(a){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.chatJid,f=a.direction,g=a.includeReferenceTimestamp,m=a.logger,n=a.range;a=a.sortFn;c("FBLogger")("messenger_web_product").info("EBMessageRangeDataSource: Issuing fetch request to EB Deanon API");m==null?void 0:m.markQPLPoint("eb_fetch_deanon_start");var o=d("MAWMessagesDirection").translateMwpDirectionToMawDirection(f),p=(i||(i=d("I64"))).to_float(d("EBFormatUtils").adjustTs(d("MAWMessagesDirection").getI64RangeTimestampForDirection(f,n),o));f=(yield d("MAWMessagesPaginationUtils").getRangeExternalIdForDirection(f,n));n=(n=c("qex")._("3653"))!=null?n:j;return(h||(h=b("Promise"))).race([d("MAWEBDeanonFetch").fetchMessagesMetadataFromEBDeanon({chatJid:e,count:n,direction:o,includeReferenceTimestamp:g,referenceExternalId:f,referenceTimestampMs:p,sortFn:a}),new h(function(a){return window.setTimeout(function(){return a(d("WAResultOrError").makeError(k))},l)})]).then(function(a){m==null?void 0:m.markQPLPoint("eb_fetch_deanon_end");return a})});return m.apply(this,arguments)}g.fetchEBDeanonMessagesMetadata=a}),98);
__d("MAWFetchDeanonMetadataUsingCache",["I64","MAWDeanonDataCheck","MAWFetchEBDeanonMessagesMetadata","MAWMessagesCompare","MAWMessagesDirection","WAJids","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using cached Deanon messages metadata for comparison\n        to local data"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using init-sync deanon data for ",""]);j=function(){return a};return a}var k=d("WATagsLogger").TAGS(["MAWFetchDeanonMetadataUsingCache"]),l=new Map(),m=c("justknobx")._("3763"),n=new Map();function a(a){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,c=a.direction,e=a.isFirstPage,f=a.logger,g=a.pageSize,h=a.range;a=a.sortFn;var j=p(b,c,f,h);if(j!=null){f==null?void 0:f.addQPLAnnotations({bool:{is_first_page:e},"int":{deanon_cached_data_size:j==null?void 0:j.length}});if(d("MAWDeanonDataCheck").hasEnoughDeanonData(j,g,e)){k.LOG(i());f==null?void 0:f.addQPLAnnotations({bool:{is_deanon_cached_data_used:!0}});return d("WAResultOrError").makeResult(j)}}g=(yield d("MAWFetchEBDeanonMessagesMetadata").fetchEBDeanonMessagesMetadata({chatJid:b,direction:c,includeReferenceTimestamp:!e,logger:f,range:h,sortFn:a}));g.success===!0&&(f==null?void 0:f.addQPLAnnotations({bool:{is_deanon_data_fetched:!0}}),r(b,c,f,g.value,h));return g});return o.apply(this,arguments)}function p(a,b,c,e){c==null?void 0:c.markQPLPoint("deanon_cache_fetch_start");s(a,b);a=(a=l.get(a))==null?void 0:a.get(b);if(a==null)return null;var f=d("MAWMessagesDirection").getI64RangeTimestampForDirection(b,e);e=(h||(h=d("I64"))).ge(f,a.minTimestampMs)&&(h||(h=d("I64"))).le(f,a.maxTimestampMs);if(!e)return null;e=d("MAWMessagesDirection").switchOnMWPMessagesDirection(b,{asc:a.msgsMetadata.findIndex(function(a){return(h||(h=d("I64"))).ge(h.of_float(a.sortOrderMs),f)}),desc:a.msgsMetadata.findIndex(function(a){return(h||(h=d("I64"))).le(h.of_float(a.sortOrderMs),f)})});b=a.msgsMetadata.slice(e);c==null?void 0:c.markQPLPoint("deanon_cache_fetch_end");return b}function q(a,b,c,d){var e;e=(e=l.get(a))!=null?e:new Map();e.set(b,{maxTimestampMs:d.max,minTimestampMs:d.min,msgsMetadata:c});l.set(a,e)}function r(a,b,c,e,f){if(e.length===0)return;c==null?void 0:c.markQPLPoint("deanon_cache_replace_start");var g=(h||(h=d("I64"))).of_float(e[e.length-1].sortOrderMs);f=d("MAWMessagesDirection").switchOnMWPMessagesDirection(b,{asc:{max:g,min:f.maxTimestampMs},desc:{max:f.minTimestampMs,min:g}});q(a,b,e,f);c==null?void 0:c.markQPLPoint("deanon_cache_replace_end")}function e(a,b){if(b.length===0)return;b=b.sort(d("MAWMessagesCompare").getSortComparisonFunctionForDirection("desc"));var c=(h||(h=d("I64"))).of_float(b[b.length-1].sortOrderMs);n.set(h.to_string(a),{insertTime:Date.now(),minTimestampMs:c,msgsMetadata:b})}function s(a,b){var c=t(a,b);if(c==null)return;k.LOG(j(),a);q(a,b,c.msgsMetadata,{max:(h||(h=d("I64"))).max_int,min:c.minTimestampMs});n["delete"](d("WAJids").threadIdForChatJid(a))}function t(a,b){if(b!=="desc")return;b=Date.now();a=n.get(d("WAJids").threadIdForChatJid(a));if(a!=null&&b-a.insertTime>m)return;return a}g.MAWFetchDeanonMetadataUsingCache=a;g.initDeanonCacheDescForThread=e}),98);
__d("MAWFetchMessagesForMLv2",["DateConsts","MAWMessagesDirection","MAWMessagesPaginationUtils","MAWSecureLocalDBFetch","MWInboxMessageSearchJumpToResultQPL","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h=(c("gkx")("9030")?30:10)*d("DateConsts").MS_PER_SEC;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.direction,f=a.includeOriginalMsg,g=a.pageSize;a=a.range;var i=d("MAWMessagesDirection").getRangeMsgIdForDirection(e,a),j=(yield d("MAWMessagesPaginationUtils").getRangeExternalIdForDirection(e,a));b=(yield c("MAWSecureLocalDBFetch")({actionType:"user",chatJid:b,config:{admin:!0,editMsgHistory:!0,media:!0,polls:!0,reactions:!0,receiverFetch:!0,xma:!0},count:g,direction:d("MAWMessagesDirection").translateMwpDirectionToMawDirection(e),offsetMsg:{externalId:j,includeOriginalMsg:f,messageId:i},timestampMs:d("MAWMessagesDirection").getI64RangeTimestampForDirection(e,a)},{timeoutMs:h}));b.success===!0&&(d("MAWMessagesPaginationUtils").populateExternalIdCache(b.value.msgs),d("MWInboxMessageSearchJumpToResultQPL").checkIfJumpedMessageAreFetched(b.value,a));return b});return i.apply(this,arguments)}g.fetchMessagesFromMAW=a}),98);
__d("MAWFetchLocalMessagesAndMetadata",["MAWFetchMessagesForMLv2","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,c=a.direction,e=a.pageSize,f=a.range;a=a.sortFn;b=(yield d("MAWFetchMessagesForMLv2").fetchMessagesFromMAW({chatJid:b,direction:c,includeOriginalMsg:!0,pageSize:e+1,range:f}));if(b.success===!1)return d("WAResultOrError").makeError(b.error);c=i(b.value.msgs).sort(a);return d("WAResultOrError").makeResult({localMsgsMetadata:c,mawFetchResult:b.value})});return h.apply(this,arguments)}function i(a){return a.map(function(a){return{externalId:a.externalId,msgType:a.type_,sortOrderMs:a.sortOrderMs}})}g["default"]=a}),98);
__d("MAWFindMsgsWithMinAndMaxTimestamp",["MAWMessagesCompare","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a.length===0)return[null,null];if(c("qex")._("18"))return h(a);a=a.toSorted(function(a,b){return((a=a.sortOrderMs)!=null?a:0)-((a=b.sortOrderMs)!=null?a:0)});return[a[0],a[a.length-1]]}function b(a){a=a.filter(function(a){return a.sortOrderMs!=null});if(a.length===0)return[null,null];if(c("qex")._("18"))return h(a);var b=null,d=null;for(var a=a,e=Array.isArray(a),f=0,a=e?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var g,i;if(e){if(f>=a.length)break;i=a[f++]}else{f=a.next();if(f.done)break;i=f.value}i=i;if(i.sortOrderMs==null)continue;(((g=b)==null?void 0:g.sortOrderMs)==null||b.sortOrderMs<i.sortOrderMs)&&(b=i);(((g=d)==null?void 0:g.sortOrderMs)==null||d.sortOrderMs>i.sortOrderMs)&&(d=i)}return[d,b]}function h(a){if(a.length===0)return[null,null];var b=d("MAWMessagesCompare").getSortComparisonFunctionForDirection("asc");a=a.filter(function(a){return a.sortOrderMs!=null}).sort(b);return[a[0],a[a.length-1]]}g.findEBMsgsWithMinAndMaxTimestamp=a;g.findMsgsWithMinAndMaxTimestamp=b}),98);
__d("MAWMessagesRangesUtils",["I64","MAWFindMsgsWithMinAndMaxTimestamp","MAWMessagesDirection","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return{hasMoreAfter:!1,hasMoreBefore:!1,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:"",maxTimestampMs:(h||(h=d("I64"))).max_int,minMessageId:"",minTimestampMs:h.min_int,threadKey:a}}function b(){return{maxExternalId:null,minExternalId:null}}function e(a){var b,e=a.direction,f=a.hasMoreMsgsInDeanon,g=a.mawFetchResult,j=a.range;a=a.rangeExternalIds;var k=[].concat(g.msgs).sort(function(a,b){return a.sortOrderMs-b.sortOrderMs}),l=k.length>0?k[0]:void 0;k=k.length>0?k[k.length-1]:void 0;var m=c("gkx")("8338");g=d("MAWMessagesDirection").switchOnMWPMessagesDirection(e,{asc:babelHelpers["extends"]({},j,{hasMoreAfter:g.hasMoreAfter||m&&f,isLoadingAfter:!1,maxMessageId:(b=k==null?void 0:k.msgId)!=null?b:j.maxMessageId,maxTimestampMs:(h||(h=d("I64"))).max(j.maxTimestampMs,(k==null?void 0:k.sortOrderMs)!=null?(h||(h=d("I64"))).of_float(k==null?void 0:k.sortOrderMs):j.maxTimestampMs)}),desc:babelHelpers["extends"]({},j,{hasMoreBefore:g.hasMoreBefore||m&&f,isLoadingBefore:!1,minMessageId:(b=l==null?void 0:l.msgId)!=null?b:j.minMessageId,minTimestampMs:h.min(j.minTimestampMs,(l==null?void 0:l.sortOrderMs)!=null?(h||(h=d("I64"))).of_float(l==null?void 0:l.sortOrderMs):j.minTimestampMs)})});m=i(e,l,k,a);return[g,m]}function f(a,b,c,e){var f,g=d("MAWFindMsgsWithMinAndMaxTimestamp").findMsgsWithMinAndMaxTimestamp(c.msgs),j=g[0];g=g[1];c=babelHelpers["extends"]({},a,d("MAWMessagesDirection").switchOnMWPMessagesDirection(e,{asc:{hasMoreAfter:c.hasMoreAfter,isLoadingAfter:!1,maxMessageId:(f=g==null?void 0:g.msgId)!=null?f:a.maxMessageId,maxTimestampMs:(h||(h=d("I64"))).max(a.maxTimestampMs,(g==null?void 0:g.sortOrderMs)!=null?(h||(h=d("I64"))).of_float(g==null?void 0:g.sortOrderMs):a.maxTimestampMs)},desc:{hasMoreBefore:c.hasMoreBefore,isLoadingBefore:!1,minMessageId:(f=j==null?void 0:j.msgId)!=null?f:a.minMessageId,minTimestampMs:h.min(a.minTimestampMs,(j==null?void 0:j.sortOrderMs)!=null?(h||(h=d("I64"))).of_float(j==null?void 0:j.sortOrderMs):a.minTimestampMs)}}));f=i(e,j,g,b);return[c,f]}function i(a,b,c,e){return babelHelpers["extends"]({},d("MAWMessagesDirection").switchOnMWPMessagesDirection(a,{asc:{maxExternalId:(a=c==null?void 0:c.externalId)!=null?a:e.maxExternalId,minExternalId:e.minExternalId},desc:{maxExternalId:e.maxExternalId,minExternalId:(c=b==null?void 0:b.externalId)!=null?c:e.minExternalId}}))}g.getRangeForFailure=a;g.getRangeExternalIdsForFailure=b;g.getNewMAWRange=e;g.mergeMoreMessagesResponseIntoRange=f;g.getNewMsgsRangesExternalIds=i}),98);
__d("MLv2LoggingUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){return"["+a.map(function(a){return"{"+a.externalId+", "+a.sortOrderMs+"}"}).join(", ")+"]"}f.getLogStrForMsgsMetadata=a}),66);
__d("EBDeanonRangeExtension",["FBLogger","I64","MAWFetchDeanonMetadataUsingCache","MAWFetchLocalMessagesAndMetadata","MAWMessagesCompare","MAWMessagesDirection","MAWMessagesRangesUtils","MAWMsgType","MAWPutMessagesToDB","MLv2LoggingUtils","Promise","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","cr:17068","nullthrows","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] MAW fetch failed: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Filtered deanon data (to be compared with local) ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Skip filtering given that it is a first page"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Raw deanon data ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Encountered unavailable or ciphertext message, EB restore is required"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] MAW fetch failed: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Deanon fetch failed: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Fetching deanon and local data for page size ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Range is not valid for EB deanon ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["Local external ids do not match de-anon. Local: [","], ToExistInLocal: [","]"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["Local data exists but in the wrong order."]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["Local data was sufficient, skipping EB restore, hasMoreMsgsInDeanon: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["Not enough local metadata, hasMoreMsgsInDeanon: ",". Expected (","), got (",")."]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["Deanon data is empty, check if de-anon API is enabled: bunnylol labyrinth <user_id>"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["Comparing deanon (size ",") and local (size ",") metadata"]);x=function(){return a};return a}var y=d("WATagsLogger").TAGS(["EBDeanonRangeExtension"]);function z(a){return a.filter(function(a){return a.type_===d("MAWMsgType").MSG_TYPE.UNAVAILABLE||a.type_===d("MAWMsgType").MSG_TYPE.CIPHERTEXT}).length>0}function A(a,b){b=d("MAWMessagesDirection").getI64RangeTimestampForDirection(a,b);return d("MAWMessagesDirection").switchOnMWPMessagesDirection(a,{asc:!(i||(i=d("I64"))).equal(b,i.max_int),desc:!i.equal(b,i.min_int)})}function a(a){return B.apply(this,arguments)}function B(){B=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.chatJid,f=a.db,g=a.direction,i=a.dispatch,j=a.logger,s=a.pageSize,t=a.range,u=a.rangeExternalIds;a=a.shouldInsertToLSDB;a=a===void 0?!0:a;if(!A(g,t)){y.LOG(r(),e,t.threadKey);return(h||(h=b("Promise"))).resolve(null)}var v=d("MAWMessagesCompare").getSortComparisonFunctionForDirection(g);y.LOG(q(),e,s);j==null?void 0:j.markQPLPoint("maw_fetch_for_deanon_optimisation_start");var w=d("MAWMessagesDirection").isFirstPageRange(t,g),x=(yield I({chatJid:e,db:f,direction:g,isFirstPage:w,logger:j,pageSize:s,range:t,rangeExternalIds:u,sortFn:v}));if(x.type==="skip"){j==null?void 0:j.addQPLAnnotations({bool:{skip_eb_opt:!0}});return x.value}else j==null?void 0:j.addQPLAnnotations({bool:{skip_eb_opt:!1}});x=x.value;x=(yield (h||(h=b("Promise"))).all([d("MAWFetchDeanonMetadataUsingCache").MAWFetchDeanonMetadataUsingCache({chatJid:e,direction:g,isFirstPage:w,logger:j,pageSize:s,range:t,sortFn:v}),x?(h||(h=b("Promise"))).resolve(x):c("MAWFetchLocalMessagesAndMetadata")({chatJid:e,direction:g,pageSize:s,range:t,sortFn:v})]));var B=x[0];x=x[1];if(B.success===!1){y.WARN(p(),e,B.error);c("FBLogger")("messenger_web_product").info("EBMessageRangeDataSource: Deanon messages metadata fetch failed, try to fetch messages from EB");return(h||(h=b("Promise"))).resolve(null)}if(x.success===!1){j==null?void 0:j.markQPLPoint("maw_fetch_for_deanon_optimisation_failed");y.WARN(o(),e,x.error);c("FBLogger")("messenger_web_product").warn("EBMessageRangeDataSource: MAW fetch fetch failed, try to fetch messages from EB");return(h||(h=b("Promise"))).resolve(null)}j==null?void 0:j.markQPLPoint("maw_fetch_for_deanon_optimisation_end");x=x.value;var E=x.localMsgsMetadata;x=x.mawFetchResult;if(z(x.msgs)){y.WARN(n(),e);return(h||(h=b("Promise"))).resolve(null)}y.LOG(m(),e,d("MLv2LoggingUtils").getLogStrForMsgsMetadata(B.value));if(w){y.LOG(l(),e);return D({db:f,deanonMsgsMetadata:B.value,direction:g,dispatch:i,localMsgsMetadata:E,logger:j,mawFetchResult:x,pageSize:s,range:t,rangeExternalIds:u,shouldInsertToLSDB:a,sortFn:v})}w=C({mawFetchResult:x,sortedDeanonMsgsMetadata:B.value,sortedLocalMsgsMetadata:E});x=w.filteredDeanonMsgsMetadata;B=w.filteredLocalMsgsMetadata;E=w.filteredMawFetchResult;y.LOG(k(),e,d("MLv2LoggingUtils").getLogStrForMsgsMetadata(x));return D({db:f,deanonMsgsMetadata:x,direction:g,dispatch:i,localMsgsMetadata:B,logger:j,mawFetchResult:E,pageSize:s,range:t,rangeExternalIds:u,shouldInsertToLSDB:a,sortFn:v})});return B.apply(this,arguments)}function C(a){var b=a.mawFetchResult,c=a.sortedDeanonMsgsMetadata;a=a.sortedLocalMsgsMetadata;if(a.length===0)return{filteredDeanonMsgsMetadata:c,filteredLocalMsgsMetadata:a,filteredMawFetchResult:b};var d=a[0].externalId,e=a[0].sortOrderMs;a=a.slice(1);c=c.slice(c.findIndex(function(a){return a.externalId===d})+1);var f=b.msgs.filter(function(a){return!(a.externalId===d&&a.sortOrderMs===e)});return{filteredDeanonMsgsMetadata:c,filteredLocalMsgsMetadata:a,filteredMawFetchResult:babelHelpers["extends"]({},b,{msgs:f})}}function D(a){return E.apply(this,arguments)}function E(){E=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.db,f=a.deanonMsgsMetadata,g=a.direction,i=a.dispatch,j=a.localMsgsMetadata,k=a.logger,l=a.mawFetchResult,m=a.pageSize,n=a.range,o=a.rangeExternalIds,p=a.shouldInsertToLSDB;a=a.sortFn;k==null?void 0:k.markQPLPoint("maw_vs_eb_deanon_comparison_start");j=F(j,f,m,a);f=j.hasMoreMsgsInDeanon;m=j.isDataPresentLocally;k==null?void 0:k.markQPLPoint("maw_vs_eb_deanon_comparison_end");k==null?void 0:k.addQPLAnnotations({bool:{is_data_restored_locally_when_extending_range:m}});c("FBLogger")("messenger_web_product").info("EBMessageRangeDataSource: Optimistic range extension using Deanon, isDataPresentLocally: %s",m.toString());if(!m)return(h||(h=b("Promise"))).resolve(null);p&&(k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_start","begin inserting the messages into LSDB"),yield d("MAWPutMessagesToDB").insertMessageResponseIntoDatabase(e,l,i,k==null?void 0:k.getInstanceKey()),k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_end"));return(h||(h=b("Promise"))).resolve(d("MAWMessagesRangesUtils").getNewMAWRange({direction:g,hasMoreMsgsInDeanon:f,mawFetchResult:l,range:n,rangeExternalIds:o}))});return E.apply(this,arguments)}function F(a,b,c,d){y.LOG(x(),b.length,a.length);if(b.length===0){y.WARN(w());return{hasMoreMsgsInDeanon:!1,isDataPresentLocally:!1}}var e=[].concat(b,a).reduce(function(a,b){a[b.externalId]=b;return a},{}),f=new Set([].concat(a.map(function(a){return a.externalId}),b.map(function(a){return a.externalId})));f=Array.from(f).map(function(a){return e[a]}).sort(d);d=f.slice(0,c);var g=new Set(f.slice(c).map(function(a){return a.externalId}));f=b.some(function(a){return g.has(a.externalId)});if(a.length<d.length){y.LOG(v(),f,d.length,a.length);return{hasMoreMsgsInDeanon:f,isDataPresentLocally:!1}}c=d.every(function(b,c){return b.externalId===a[c].externalId});if(c)y.LOG(u(),f);else{var h=new Set(a.map(function(a){return a.externalId}));d.every(function(a,b){return h.has(a.externalId)})&&y.WARN(t());y.LOG(s(),a.map(function(a){return a.externalId}).join(", "),d.map(function(a){return a.externalId}).join(", "))}return{hasMoreMsgsInDeanon:f,isDataPresentLocally:c}}function G(a,b){return H.apply(this,arguments)}function H(){H=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield a.tables.threads.get(b));return a==null?null:a.lastActivityTimestampMs});return H.apply(this,arguments)}function I(a){return J.apply(this,arguments)}function J(){J=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.chatJid,f=a.db,g=a.direction,h=a.isFirstPage,k=a.logger,l=a.pageSize,m=a.range,n=a.rangeExternalIds;a=a.sortFn;if(b("cr:17068")==null||!h)return{type:"fetch"};h=(h=c("qex")._("3540"))!=null?h:0;var o=(yield b("cr:17068")());if(o==null)return{type:"fetch"};var p=o.deviceRegTime;o=o.lastActivityTime;if(d("WATimeUtils").unixTime()-o>h)return{type:"fetch"};o=(i||(i=d("I64"))).div(c("nullthrows")(yield G(f,m.threadKey)),i.of_int32(1e3));var q=i.of_float(p);if((i||(i=d("I64"))).lt(o,q))return{type:"fetch"};k==null?void 0:k.markQPLPoint("maw_fetch_for_deanon_skip_optimisation_start");h=(yield c("MAWFetchLocalMessagesAndMetadata")({chatJid:e,direction:g,pageSize:l,range:m,sortFn:a}));if(h.success===!1){k==null?void 0:k.markQPLPoint("maw_fetch_for_deanon_skip_optimisation_failed");y.WARN(j(),e,h.error);c("FBLogger")("messenger_web_product").warn("EBMessageRangeDataSource: MAW fetch fetch failed, try to fetch messages from EB");return{type:"fetch"}}k==null?void 0:k.markQPLPoint("maw_fetch_for_deanon_skip_optimisation_end");f=h.value.localMsgsMetadata.filter(function(a){var b=a.isOutgoing;a=a.sortOrderMs;return b!==!0&&(i||(i=d("I64"))).ge((i||(i=d("I64"))).of_float(a/1e3),q)});return f.length<l?{type:"fetch",value:h}:{type:"skip",value:yield d("MAWMessagesRangesUtils").getNewMAWRange({direction:g,hasMoreMsgsInDeanon:!0,mawFetchResult:h.value.mawFetchResult,range:m,rangeExternalIds:n})}});return J.apply(this,arguments)}g.getRangeFromLocalDataIfConsistent=a;g.excludeOffsetMsg=C;g.isDeanonDataPresentLocally=F}),98);
__d("MAWFetchMessagesFromEBForMLv2",["EbFetchTimeoutMsForMLv2","I64","MAWEBFetch","MAWEBMsgsWithSameSortOrderFix","MAWMessagesDirection","MAWMessagesPaginationUtils","MAWTraceUtils","MWEncryptedBackUpEBNotEnabledError","Promise","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","recoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["EBMessageRangeDataSource: Failed to fetch messages from EB. Message: "," TraceId: "," Request: ",""]);j=function(){return a};return a}var k="timeout";function a(a){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.chatJid,f=a.db,g=a.direction,l=a.logger,n=a.pageSize;a=a.range;l==null?void 0:l.markQPLPoint("wait_eb_fetch_start");var o=d("MAWMessagesDirection").getI64RangeTimestampForDirection(g,a),p=e+":"+(i||(i=d("I64"))).to_string(o)+":"+g+":"+n,q=(yield d("MAWMessagesPaginationUtils").getRangeExternalIdForDirection(g,a)),r=d("MAWEBMsgsWithSameSortOrderFix").overFetchEBMsgsIfNeeded(n,q),s=d("MAWMessagesDirection").translateMwpDirectionToMawDirection(g),t=d("MAWTraceUtils").createTraceId();e=(yield (h||(h=b("Promise"))).race([c("MAWEBFetch")({chatJid:e,count:r,db:f,direction:s,timestampMs:o,traceId:t}),new h(function(a){return window.setTimeout(function(){return a(d("WAResultOrError").makeError(k))},c("EbFetchTimeoutMsForMLv2")())})]));if(e.success===!1){l==null?void 0:l.markQPLPoint("eb_fetch_response_fail");l==null?void 0:l.addQPLAnnotations({string:{eb_failure_reason:e.error,eb_restore_status:e.error}});e.error!==k&&e.error!==d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED&&d("WATagsLogger").TAGS(["maw_message_core","EBMessageRangeDataSource",t]).ERROR(j(),e.error,t,p);return e}l==null?void 0:l.addQPLAnnotations({string:{eb_restore_status:"success",eb_restore_type:(r=e.value)==null?void 0:r.restoreType}});f=d("MAWEBMsgsWithSameSortOrderFix").fixEBFetchResultPagination({direction:s,ebFetchResult:e.value,msgCount:n,referenceExternalId:q});o=m({direction:g,fetchResult:f,range:a});l==null?void 0:l.markQPLPoint("wait_eb_fetch_end");return d("WAResultOrError").makeResult({raw:f,recovered:o})});return l.apply(this,arguments)}function m(a){var b=a.direction,e=a.fetchResult,f=a.range;a=b==="asc"?e.messages.filter(function(a){return a.sortOrderMs!=null&&(i||(i=d("I64"))).ge((i||(i=d("I64"))).of_float(a.sortOrderMs),f.maxTimestampMs)}):e.messages.filter(function(a){return a.sortOrderMs!=null&&(i||(i=d("I64"))).le((i||(i=d("I64"))).of_float(a.sortOrderMs),f.minTimestampMs)});var g=babelHelpers["extends"]({},e,{messages:a});a.length!==e.messages.length&&c("recoverableViolation")("EBMessageRangeDataSource: EB fetch API returned invalid messages outside requested timerange","messenger_web_product");a.length===0&&(b==="asc"&&e.hasMoreAfter&&(g.hasMoreAfter=!1,c("recoverableViolation")("EBMessageRangeDataSource: Unexpected null messages after","messenger_web_product")),b==="desc"&&e.hasMoreBefore&&(g.hasMoreBefore=!1,c("recoverableViolation")("EBMessageRangeDataSource: Unexpected null messages before","messenger_web_product")));return g}g["default"]=a}),98);
__d("ReplayLastSubjectWithMapper",["relay-runtime"],(function(a,b,c,d,e,f,g){"use strict";var h=Object.freeze({});a=function(){function a(a,b){var c=this;a===void 0&&(a=h);this.$1=!1;this.$5=new Set();this.$3=a;this.$6=b;this.$4=d("relay-runtime").Observable.create(function(a){if(c.$1){c.$2!=null?a.error(c.$2):a.complete();return}c.$5.add(a);c.$3!==h&&a.next(c.$6(c.$3));return function(){c.$5["delete"](a)}})}var b=a.prototype;b.next=function(a){if(this.$1)return;if(this.$3===a)return;this.$3=a;this.$5.forEach(function(b){return b.next(a)})};b.error=function(a){if(this.$1)return;this.$1=!0;this.$2=a;this.$5.forEach(function(b){return b.error(a)})};b.complete=function(){if(this.$1)return;this.$1=!0;this.$5.forEach(function(a){return a.complete()})};b.subscribe=function(a){return this.$4.subscribe(a)};return a}();g.ReplayLastSubjectWithMapper=a}),98);
__d("MAWMessageRangeDataExternalObservables",["ReplayLastSubjectWithMapper","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(){this.$1=[]}var b=a.prototype;b.getOrCreateExternalObservableForRange=function(a,b){var c=this.$1.find(function(b){var c=b[0];b[1];return a===c});if(c!=null)return c[1];c=new(d("ReplayLastSubjectWithMapper").ReplayLastSubjectWithMapper)({range:a.value,rangeExternalIds:b,type:"range_only"},function(a){var b=a.range;a=a.rangeExternalIds;return{range:b,rangeExternalIds:a,type:"range_only"}});this.$1.push([a,c]);return c};b.updateExternalObservableWithRange=function(a,b){var d=c("nullthrows")(this.$1.find(function(b){b[0];b=b[1];return b===a}));d[0]!==b&&(d[0]=b)};return a}();g.MAWMessageRangeDataExternalObservables=a}),98);
__d("MAWWaitForACTThreadReadyForMLv2",["MAWMiActGetThreadLifecycleState","MAWMiActOnActThreadReady","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,d){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){var f=(yield d("MAWMiActGetThreadLifecycleState").getThreadLifecycleStateByThreadKey(a,b,c));e==null?void 0:e.addQPLAnnotations({string:{mi_act_thread_state_type:f.type}});e=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a,b,c));return e});return h.apply(this,arguments)}g.waitForACTThreadReadyForMLv2=a}),98);
__d("MLV2RangeExtensionLogger",["I64","MAWQPLLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){i==null&&(i=c("MAWQPLLogger")(c("qpl")._(1056843758,"1768")));return i}var k=new Map();function l(a,b){return(h||(h=d("I64"))).to_string(a)+b}function a(a,b,c,e){var f=l(a,b),g=k.get(f);g!=null&&g.markQPLCancel("restart_logger");var i=j().markQPLStart(),m=new Set();g={addQPLAnnotations:function(a){j().addQPLAnnotations(i,a)},annotateMessageRangesDataSource:function(a){m.add(a),j().addQPLAnnotations(i,{string_array:{message_ranges_source:Array.from(m.keys())}})},getInstanceKey:function(){return i},markQPLCancel:function(a){j().addQPLAnnotations(i,{string:{cancel_reason:a}}),j().markQPLCancel(i),k["delete"](f)},markQPLFailure:function(a){j().markQPLFailure(i,a),k["delete"](f)},markQPLFailureWithMsg:function(a){j().markQPLFailureWithMsg(i,a),k["delete"](f)},markQPLPoint:function(a){j().markQPLPoint(i,a)},markQPLSuccess:function(){j().markQPLSuccess(i),k["delete"](f)}};g.addQPLAnnotations({bool:{is_initial_range:(h||(h=d("I64"))).equal(c.minTimestampMs,(h||(h=d("I64"))).max_int)&&(h||(h=d("I64"))).equal(c.maxTimestampMs,(h||(h=d("I64"))).max_int)},"int":{page_size:e},string:{direction:b,start_range:JSON.stringify(babelHelpers["extends"]({},c,{maxTimestampMs:c.maxTimestampMs==null?null:(h||(h=d("I64"))).to_string(c.maxTimestampMs),minTimestampMs:c.minTimestampMs==null?null:(h||(h=d("I64"))).to_string(c.minTimestampMs)})),thread_id:(h||(h=d("I64"))).to_string(a)}});k.set(f,g);return g}function b(a,b){a=l(a,b);return k.get(a)}g.startRangeExtensionLoggerForThread=a;g.getRangeExtensionLoggerForThread=b}),98);
__d("MessageRangeSet",["I64","ReplayLastSubject","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(b){babelHelpers.inheritsLoose(a,b);function a(a){var c;c=b.call(this,a)||this;c.value=a;return c}var c=a.prototype;c.next=function(a){this.value=a,b.prototype.next.call(this,a)};return a}(d("ReplayLastSubject").ReplayLastSubject),j=function(b){babelHelpers.inheritsLoose(a,b);function a(a){var c;c=b.call(this,a)||this;for(var d=arguments.length,e=new Array(d>1?d-1:0),f=1;f<d;f++)e[f-1]=arguments[f];e.forEach(function(a){c.subscribe({complete:function(){return a.complete()},error:function(b){return a.error(b)},next:function(b){return a.next(b)}})});c.next(a);return c}return a}(i);a=function(){function a(){this.$1=new Set()}var b=a.prototype;b.$2=function(a){for(var b=this.$1,c=Array.isArray(b),e=0,b=c?b:b[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(c){if(e>=b.length)break;f=b[e++]}else{e=b.next();if(e.done)break;f=e.value}f=f;var g=f.value;if((h||(h=d("I64"))).le(g.minTimestampMs,a)&&((h||(h=d("I64"))).ge(g.maxTimestampMs,a)||!g.hasMoreAfter))return f}return null};b.getRangeForTimestamp=function(a){return this.$2(a)};b.upsertRange=function(a){var b=Array.from(this.$1.values()).filter(function(b){return l(b.value,a)});if(b.length===0){var c=new i(a);this.$1.add(c);return c}c=k.apply(void 0,b.map(function(a){return a.value}).concat([a]));if(b.length===1){var d=b[0];d.next(c);return d}for(var d=b,e=Array.isArray(d),f=0,d=e?d:d[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var g;if(e){if(f>=d.length)break;g=d[f++]}else{f=d.next();if(f.done)break;g=f.value}g=g;this.$1["delete"](g)}g=babelHelpers.construct(j,[c].concat(b));this.$1.add(g);return g};return a}();function k(){for(var a=arguments.length,b=new Array(a),e=0;e<a;e++)b[e]=arguments[e];if(b.length===0)throw c("err")("Cannot merge 0 ranges");var f=b[0].threadKey,g=b[0].minTimestampMs,i=b[0].hasMoreAfter,j=b[0].hasMoreBefore,k=b[0].maxMessageId,l=b[0].minMessageId,m=b[0].maxTimestampMs;for(var n=1;n<b.length;n++){var o=b[n];(h||(h=d("I64"))).le(o.minTimestampMs,g)&&((h||(h=d("I64"))).equal(o.minTimestampMs,g)?j=j&&o.hasMoreBefore:j=o.hasMoreBefore,g=o.minTimestampMs,l=o.minMessageId);(h||(h=d("I64"))).ge(o.maxTimestampMs,m)&&((h||(h=d("I64"))).equal(o.maxTimestampMs,m)?i=i&&o.hasMoreAfter:i=o.hasMoreAfter,m=o.maxTimestampMs,k=o.maxMessageId)}return{hasMoreAfter:i,hasMoreBefore:j,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:k,maxTimestampMs:m,minMessageId:l,minTimestampMs:g,threadKey:f}}function l(a,b){var c=(h||(h=d("I64"))).le(b.minTimestampMs,a.minTimestampMs),e=c?b:a;c=c?a:b;return m(e,c.minTimestampMs)?!0:!1}function m(a,b){return(h||(h=d("I64"))).ge(b,a.minTimestampMs)&&(h||(h=d("I64"))).le(b,a.maxTimestampMs)}g.MessageRangeSet=a;g.Subject=i}),98);
__d("ReQLObservable",["SortedAsyncIterable","applyChangesToBPlusTree","asyncToGeneratorRuntime","createBPlusTreeFromSorted","isPromise","promiseDone","relay-runtime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,e){return d("relay-runtime").Observable.create(function(f){var g=e(a),i=function(a){if(f.closed)return;f.next(a)},j,k=[],l=g.subscribe(function(a,b){k.push([a,b])}),m=a.subscribeToCommit(function(){if(f.closed)return;if(j!=null&&k.length>0){var a=j;c("applyChangesToBPlusTree")(a,k)&&i(Array.from(a.entries()))}}),n=g.iterator(d("SortedAsyncIterable").getOrCreateContext(g)),o=[];c("promiseDone")(b("asyncToGeneratorRuntime").asyncToGenerator(function*(){while(!f.closed){var a=n.next();(h||(h=c("isPromise")))(a)&&(a=(yield a));if(a.done)break;o.push(a.value)}if(f.closed)return;a=j=c("createBPlusTreeFromSorted")(o,g.direction);i(c("applyChangesToBPlusTree")(a,k)?Array.from(a.entries()):o)})());return function(){l(),m()}})}g.create=a}),98);
__d("switchMap",["relay-runtime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("relay-runtime").Observable.create(function(c){var d,e=a.subscribe({complete:c.complete,error:c.error,next:function(a){var e;(e=d)==null?void 0:e.unsubscribe();d=b(a).subscribe(c)}});return function(){var a;(a=d)==null?void 0:a.unsubscribe();e.unsubscribe()}})}g["default"]=a}),98);
__d("EBMessageRangeDataSource",["EBDeanonRangeExtension","FBLogger","I64","LSDatabaseSingleton","LSEncryptedBackupsBackupTenancy","LSIntEnum","MAWEncryptedBackupUtils","MAWFetchMessagesForMLv2","MAWFetchMessagesFromEBForMLv2","MAWFindMsgsWithMinAndMaxTimestamp","MAWMessageIntegrityEBFetchStatus","MAWMessageRangeDataExternalObservables","MAWMessagesDirection","MAWMessagesPaginationUtils","MAWMessagesRangesUtils","MAWPutMessagesToDB","MAWWaitForACTThreadReadyForMLv2","MLV2DataSourceLogger","MLV2RangeExtensionLogger","MessageRangeSet","Promise","ReQL","ReQLObservable","ReplayLastSubject","asyncToGeneratorRuntime","err","gkx","nullthrows","recoverableViolation","relay-runtime","switchMap"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=function(){function a(a){var e=this;this.$2=new(d("MessageRangeSet").MessageRangeSet)();this.$3=new(d("MAWMessageRangeDataExternalObservables").MAWMessageRangeDataExternalObservables)();this.getOrCreateMessageRangeCoveringCursor=function(a,b,c){c=e.$2.getRangeForTimestamp(a.timestampMs);b==null?void 0:b.annotateMessageRangesDataSource("EBMessageRangeDataSource");if(c!=null){b={maxExternalId:null,minExternalId:null};return e.$3.getOrCreateExternalObservableForRange(c,b)}c=(k||(k=d("I64"))).equal(a.timestampMs,k.max_int);b={hasMoreAfter:!c,hasMoreBefore:!0,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:(b=a.messageId)!=null?b:"",maxTimestampMs:a.timestampMs,minMessageId:(c=a.messageId)!=null?c:"",minTimestampMs:a.timestampMs,threadKey:e.$1};c=e.$2.upsertRange(b);return e.$3.getOrCreateExternalObservableForRange(c,{maxExternalId:a==null?void 0:a.externalId,minExternalId:a==null?void 0:a.externalId})};this.$4=function(a){var b=d("MLV2DataSourceLogger").getMLV2LoggerForThread(e.$1,a),c=d("MLV2RangeExtensionLogger").getRangeExtensionLoggerForThread(e.$1,a);a={addQPLAnnotations:function(a){b==null?void 0:b.addQPLAnnotations(a),c==null?void 0:c.addQPLAnnotations(a)},annotateMessageRangesDataSource:function(a){b==null?void 0:b.annotateMessageRangesDataSource(a),c==null?void 0:c.annotateMessageRangesDataSource(a)},getInstanceKey:function(){var a;return(a=b==null?void 0:b.getInstanceKey())!=null?a:0},markQPLCancel:function(a){b==null?void 0:b.markQPLCancel(a),c==null?void 0:c.markQPLCancel(a)},markQPLFailure:function(a){b==null?void 0:b.markQPLFailure(a),c==null?void 0:c.markQPLFailure(a)},markQPLFailureWithMsg:function(a){b==null?void 0:b.markQPLFailureWithMsg(a),c==null?void 0:c.markQPLFailureWithMsg(a)},markQPLPoint:function(a,d){b==null?void 0:b.markQPLPoint(a,d),c==null?void 0:c.markQPLPoint(a,d)},markQPLSuccess:function(a){b==null?void 0:b.markQPLSuccess(a),c==null?void 0:c.markQPLSuccess()}};return a};this.extendRange=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,f,g,i,j){var l=e.$4(g);l==null?void 0:l.annotateMessageRangesDataSource("EBMessageRangeDataSource");l==null?void 0:l.markQPLPoint("eb_extend_range_start");var m=e.$2.getRangeForTimestamp(a.minTimestampMs);if(m==null){c("recoverableViolation")("EBDataSource: Requested to extend a nonexisting range","maw_message_core");l==null?void 0:l.markQPLPoint("extend_range_invalid");return(h||(h=b("Promise"))).resolve()}var n=m.value;a=(yield d("MAWMessagesPaginationUtils").getMessagesRangesV2ExternalIdsIfChanged(a,n,f));if(g==="asc"&&(!n.hasMoreAfter||n.isLoadingAfter)){l==null?void 0:l.markQPLPoint("extend_range_skipped");return(h||(h=b("Promise"))).resolve()}if(g==="desc"&&(!n.hasMoreBefore||n.isLoadingBefore)){l==null?void 0:l.markQPLPoint("extend_range_skipped");return(h||(h=b("Promise"))).resolve()}f=e.$3.getOrCreateExternalObservableForRange(m,a);f.next({range:babelHelpers["extends"]({},n,{isLoadingAfter:n.isLoadingAfter||g==="asc",isLoadingBefore:n.isLoadingBefore||g==="desc"}),rangeExternalIds:a,type:"range_only"});var o={maxMessageId:m.value.maxMessageId,maxTimestampMs:m.value.maxTimestampMs,minMessageId:m.value.minMessageId,minTimestampMs:m.value.minTimestampMs};return e.$5(m.value,a,f,g,i,j).then(function(){var a=(k||(k=d("I64"))).equal(o.maxTimestampMs,m.value.maxTimestampMs)&&(k||(k=d("I64"))).equal(o.minTimestampMs,m.value.minTimestampMs)&&m.value.maxMessageId===o.maxMessageId&&m.value.minMessageId===o.minMessageId;l==null?void 0:l.addQPLAnnotations({bool:{extended_range_is_identical_eb:a}})})["catch"](function(a){l==null?void 0:l.markQPLPoint("eb_extend_range_failed");l==null?void 0:l.addQPLAnnotations({string:{range_extension_error:a instanceof Error?a.message:"unknown_error"}});throw a})});return function(b,c,d,e,f){return a.apply(this,arguments)}}();this.truncateMessageRange=function(a){};this.$5=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,f,g,h,j){var k=e.$4(g),l=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton);k==null?void 0:k.markQPLPoint("eb_wait_act_thread_start");var m=(yield d("MAWWaitForACTThreadReadyForMLv2").waitForACTThreadReadyForMLv2(l.tables,e.$1,"EBMessageRangeDataSourceForThread",k));m=m.chatJid;k==null?void 0:k.markQPLPoint("eb_wait_act_thread_end");var n=(yield d("EBDeanonRangeExtension").getRangeFromLocalDataIfConsistent({chatJid:m,db:l,direction:g,dispatch:j,logger:k,pageSize:h,range:a,rangeExternalIds:b}));if(n!=null){var o=n[0];n=n[1];k==null?void 0:k.addQPLAnnotations({string:{eb_restore_status:"skipped"}});k==null?void 0:k.markQPLPoint("maw_upsert_range_from_local_start");e.$7(f,babelHelpers["extends"]({},o,{threadKey:e.$1}),n);k==null?void 0:k.markQPLPoint("maw_upsert_range_from_local_end");return}k==null?void 0:k.addQPLAnnotations({string:{eb_restore_status:"pending"}});o=(yield c("MAWFetchMessagesFromEBForMLv2")({chatJid:m,db:l,direction:g,logger:k,pageSize:h,range:a}));if(o.success===!1){d("MAWMessageIntegrityEBFetchStatus").recordEBFailure(e.$1);k==null?void 0:k.markQPLPoint("eb_fallback_fetch_messages_from_maw_start");n=(yield d("MAWFetchMessagesForMLv2").fetchMessagesFromMAW({chatJid:m,direction:g,includeOriginalMsg:!1,pageSize:h,range:a}));k==null?void 0:k.markQPLPoint("eb_fallback_fetch_messages_from_maw_end");if(n.success===!1){k==null?void 0:k.markQPLPoint("eb_fallback_update_range_failed");e.$7(f,d("MAWMessagesRangesUtils").getRangeForFailure(e.$1),d("MAWMessagesRangesUtils").getRangeExternalIdsForFailure());return}n=d("MAWMessagesRangesUtils").mergeMoreMessagesResponseIntoRange(a,b,n.value,g);var p=n[0];n=n[1];k==null?void 0:k.markQPLPoint("eb_fallback_update_range_success");e.$7(f,p,n);return}k==null?void 0:k.markQPLPoint("maw_fetch_messages_from_eb_range_start");p=(yield d("MAWFetchMessagesForMLv2").fetchMessagesFromMAW({chatJid:m,direction:g,includeOriginalMsg:!1,pageSize:h,range:a}));if(p.success===!1){k==null?void 0:k.markQPLPoint("maw_fetch_messages_from_eb_range_failed");throw(n=p.payload)!=null?n:c("err")(p.error)}k==null?void 0:k.markQPLPoint("maw_fetch_messages_from_eb_range_end");k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_start","begin inserting the messages into LSDB");yield d("MAWPutMessagesToDB").insertMessageResponseIntoDatabase(l,p.value,j,k==null?void 0:k.getInstanceKey());k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_end");e.$6({direction:g,ebFetchResult:o.value,externalObservable:f,logger:k,mawFetchResult:p.value,range:a,rangeExternalIds:b})});return function(b,c,d,e,f,g){return a.apply(this,arguments)}}();this.$1=a}var e=a.prototype;e.$6=function(a){var b=a.direction,e=a.ebFetchResult,f=a.externalObservable,g=a.logger,h=a.mawFetchResult,i=a.range;a=a.rangeExternalIds;g==null?void 0:g.markQPLPoint("maw_upsert_range_from_eb_start");var j=e.raw,l=e.recovered.messages,m=l.map(function(a){return a.sortOrderMs}).filter(Boolean);m=[Math.min.apply(Math,m),Math.max.apply(Math,m)];var n=m[0];m=m[1];var o=d("MAWMessagesDirection").getI64RangeTimestampForDirection(b,i),p=b==="desc"?[(k||(k=d("I64"))).of_float(n),o]:[o,(k||(k=d("I64"))).of_float(m)];n=h.msgs.filter(function(a){return(k||(k=d("I64"))).ge((k||(k=d("I64"))).of_float(a.sortOrderMs),p[0])&&(k||(k=d("I64"))).le((k||(k=d("I64"))).of_float(a.sortOrderMs),p[1])});var q,r;if(n.length===0){o=c("gkx")("842")||c("gkx")("4767");if(!o){c("recoverableViolation")("EBMessageRangeDataSource: No local messages found within EB response range","messenger_web_product");g==null?void 0:g.markQPLPoint("eb_fetch_has_no_local_msg_overlap");this.$7(f,d("MAWMessagesRangesUtils").getRangeForFailure(this.$1),d("MAWMessagesRangesUtils").getRangeExternalIdsForFailure());return}c("FBLogger")("messenger_web_product").mustfix("EBMessageRangeDataSource: No local messages found within EB response range for protobuf. Filtered EB payload size: %s, original EB payload size: %s, original EB hasMoreBefore: %s, original EB hasMoreAfter: %s",l.length,j.messages.length,j.hasMoreBefore,j.hasMoreAfter);m=d("MAWFindMsgsWithMinAndMaxTimestamp").findEBMsgsWithMinAndMaxTimestamp(l);q=m[0];r=m[1]}else{h=d("MAWFindMsgsWithMinAndMaxTimestamp").findMsgsWithMinAndMaxTimestamp(n);q=h[0];r=h[1]}o=d("MAWMessagesDirection").switchOnMWPMessagesDirection(b,{asc:function(){var a,b;a=(a=(a=r)==null?void 0:a.msgId)!=null?a:i.maxMessageId;b=(k||(k=d("I64"))).max(i.maxTimestampMs,((b=r)==null?void 0:b.sortOrderMs)!=null?(k||(k=d("I64"))).of_float((b=r)==null?void 0:b.sortOrderMs):i.maxTimestampMs);if(j.hasMoreAfter===!0){var f=!1;(k||(k=d("I64"))).equal(i.maxTimestampMs,b)&&i.maxMessageId===a?(c("FBLogger")("messenger_web_product").mustfix("EBMessageRangeDataSource: stuck in the same max timestamp: %s",(k||(k=d("I64"))).to_string(b)),f=!0,b=k.add(b,k.of_int32(1))):j.isEndOfCurrentFormat===!0&&(f=!0);f&&(b=(k||(k=d("I64"))).equal(b,(k||(k=d("I64"))).max_int)?b:(k||(k=d("I64"))).add(b,(k||(k=d("I64"))).of_int32(1)))}return babelHelpers["extends"]({},i,{hasMoreAfter:e.recovered.hasMoreAfter,isLoadingAfter:!1,maxMessageId:a,maxTimestampMs:b})},desc:function(){var a,b;a=(a=(a=q)==null?void 0:a.msgId)!=null?a:i.minMessageId;b=(k||(k=d("I64"))).min(i.minTimestampMs,((b=q)==null?void 0:b.sortOrderMs)!=null?(k||(k=d("I64"))).of_float((b=q)==null?void 0:b.sortOrderMs):i.minTimestampMs);if(j.hasMoreBefore===!0){var f=!1;(k||(k=d("I64"))).equal(i.minTimestampMs,b)&&i.minMessageId===a?(c("FBLogger")("messenger_web_product").mustfix("EBMessageRangeDataSource: stuck in the same min timestamp: %s",(k||(k=d("I64"))).to_string(b)),f=!0):j.isEndOfCurrentFormat===!0&&(f=!0);f&&(b=(k||(k=d("I64"))).equal(b,(k||(k=d("I64"))).min_int)?b:(k||(k=d("I64"))).sub(b,(k||(k=d("I64"))).of_int32(1)))}return babelHelpers["extends"]({},i,{hasMoreBefore:e.recovered.hasMoreBefore,isLoadingBefore:!1,minMessageId:a,minTimestampMs:b})}});l=o();m=d("MAWMessagesRangesUtils").getNewMsgsRangesExternalIds(b,q,r,a);this.$7(f,l,m);g==null?void 0:g.markQPLPoint("maw_upsert_range_from_eb_end")};e.$7=function(a,b,c){b=this.$2.upsertRange(b);a.next({range:b.value,rangeExternalIds:c,type:"range_only"})};return a}(),m=function(){function a(a){var e=this;this.$1=new Map();this.$3=!1;this.getOrCreateMessageRangeCoveringCursor=function(a,b,f){var g=a.threadKey;return c("switchMap")(e.$2,function(c){return!c?d("relay-runtime").Observable.from(new(d("ReplayLastSubject").ReplayLastSubject)({range:{hasMoreAfter:!1,hasMoreBefore:!1,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:"",maxTimestampMs:(k||(k=d("I64"))).max_int,minMessageId:"",minTimestampMs:k.min_int,threadKey:g},rangeExternalIds:{maxExternalId:null,minExternalId:null},type:"range_only"})):d("relay-runtime").Observable.from(e.$4(g).getOrCreateMessageRangeCoveringCursor(a,b,f))})};this.extendRange=function(a,c,f,g,i){var j=a.threadKey,k=d("MLV2DataSourceLogger").getMLV2LoggerForThread(j,f);if(!e.$3){k==null?void 0:k.markQPLPoint("eb_extend_range_skipped_due_to_disabled");return(h||(h=b("Promise"))).resolve()}return e.$4(j).extendRange(a,c,f,g,i)};this.truncateMessageRange=function(a){e.$1["delete"]((k||(k=d("I64"))).to_string(a))};this.$2=d("ReQLObservable").create(a,function(){return d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_client_state).take(1).map(function(a){var b=d("MAWEncryptedBackupUtils").getBackupTenancyFromClientStateRow(a);b!=null&&a.backupTenancy==null&&c("FBLogger")("messenger_web_product").warn("Previously broken state of invalid backup tenancy is caught");return b!=null&&(k||(k=d("I64"))).equal(b,(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION))})}).map(function(a){return Boolean(a==null?void 0:(a=a[0])==null?void 0:a[1])})["do"]({next:function(a){e.$3=a}})}var e=a.prototype;e.$4=function(a){var b=(k||(k=d("I64"))).to_string(a);if(!this.$1.has(b)){a=new l(a);this.$1.set(b,a)}return c("nullthrows")(this.$1.get(b))};return a}(),n,o;function a(a){(n==null||o!==a)&&(o=a,n=new m(a));return n}g["default"]=a}),98);
__d("MAWMessageRangeDataSource",["I64","LSDatabaseSingleton","MAWFetchMessagesForMLv2","MAWMessageRangeDataExternalObservables","MAWMessagesPaginationUtils","MAWMessagesRangesUtils","MAWPutMessagesToDB","MAWTimedBridge","MAWWaitForACTThreadReadyForMLv2","MLV2DataSourceLogger","MLV2RangeExtensionLogger","MessageRangeSet","Promise","WATagsLogger","asyncToGeneratorRuntime","err","gkx","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWMessageRangeDataSource: Failed to fetch messages from worker due to ",". Error: ",""]);k=function(){return a};return a}var l=5,m=function(){function a(a){var e=this;this.$2=new(d("MessageRangeSet").MessageRangeSet)();this.$3=l;this.$4=new(d("MAWMessageRangeDataExternalObservables").MAWMessageRangeDataExternalObservables)();this.getOrCreateMessageRangeCoveringCursor=function(a,b,c){b==null?void 0:b.annotateMessageRangesDataSource("MAWMessageRangeDataSource");b==null?void 0:b.markQPLPoint("maw_get_or_create_range_start");c=e.$2.getRangeForTimestamp(a.timestampMs);if(c!=null){b==null?void 0:b.markQPLPoint("maw_preexisting_range");b==null?void 0:b.markQPLPoint("maw_get_or_create_range_end");var f={maxExternalId:null,minExternalId:null};return e.$4.getOrCreateExternalObservableForRange(c,f)}c=(j||(j=d("I64"))).equal(a.timestampMs,j.max_int);f={hasMoreAfter:!c,hasMoreBefore:!0,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:(f=a.messageId)!=null?f:"",maxTimestampMs:a.timestampMs,minMessageId:(c=a.messageId)!=null?c:"",minTimestampMs:a.timestampMs,threadKey:e.$1};c=e.$2.upsertRange(f);b==null?void 0:b.markQPLPoint("maw_range_created");b==null?void 0:b.markQPLPoint("maw_get_or_create_range_end");return e.$4.getOrCreateExternalObservableForRange(c,{maxExternalId:a==null?void 0:a.externalId,minExternalId:a==null?void 0:a.externalId})};this.$5=function(a){var b=d("MLV2DataSourceLogger").getMLV2LoggerForThread(e.$1,a),c=d("MLV2RangeExtensionLogger").getRangeExtensionLoggerForThread(e.$1,a);a={addQPLAnnotations:function(a){b==null?void 0:b.addQPLAnnotations(a),c==null?void 0:c.addQPLAnnotations(a)},annotateMessageRangesDataSource:function(a){b==null?void 0:b.annotateMessageRangesDataSource(a),c==null?void 0:c.annotateMessageRangesDataSource(a)},getInstanceKey:function(){var a;return(a=b==null?void 0:b.getInstanceKey())!=null?a:0},markQPLCancel:function(a){b==null?void 0:b.markQPLCancel(a),c==null?void 0:c.markQPLCancel(a)},markQPLFailure:function(a){b==null?void 0:b.markQPLFailure(a),c==null?void 0:c.markQPLFailure(a)},markQPLFailureWithMsg:function(a){b==null?void 0:b.markQPLFailureWithMsg(a),c==null?void 0:c.markQPLFailureWithMsg(a)},markQPLPoint:function(a,d){b==null?void 0:b.markQPLPoint(a,d),c==null?void 0:c.markQPLPoint(a,d)},markQPLSuccess:function(a){b==null?void 0:b.markQPLSuccess(a),c==null?void 0:c.markQPLSuccess()}};return a};this.extendRange=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,f,g,i){var k=e.$5(f);k==null?void 0:k.annotateMessageRangesDataSource("MAWMessageRangeDataSource");k==null?void 0:k.markQPLPoint("maw_extend_range_start");var l=e.$2.getRangeForTimestamp(a.minTimestampMs);if(l==null){k==null?void 0:k.markQPLPoint("extend_range_invalid");return(h||(h=b("Promise"))).resolve()}var m=l.value;a=(yield d("MAWMessagesPaginationUtils").getMessagesRangesV2ExternalIdsIfChanged(a,m,c));if(f==="asc"&&(!m.hasMoreAfter||m.isLoadingAfter)){k==null?void 0:k.markQPLPoint("extend_range_skipped");return(h||(h=b("Promise"))).resolve()}if(f==="desc"&&(!m.hasMoreBefore||m.isLoadingBefore)){k==null?void 0:k.markQPLPoint("extend_range_skipped");return(h||(h=b("Promise"))).resolve()}c=e.$4.getOrCreateExternalObservableForRange(l,a);c.next({range:babelHelpers["extends"]({},m,{isLoadingAfter:m.isLoadingAfter||f==="asc",isLoadingBefore:m.isLoadingBefore||f==="desc"}),rangeExternalIds:a,type:"range_only"});var n={maxMessageId:l.value.maxMessageId,maxTimestampMs:l.value.maxTimestampMs,minMessageId:l.value.minMessageId,minTimestampMs:l.value.minTimestampMs};return e.$6(l.value,a,c,f,g,i).then(function(){var a=(j||(j=d("I64"))).equal(n.maxTimestampMs,l.value.maxTimestampMs)&&(j||(j=d("I64"))).equal(n.minTimestampMs,l.value.minTimestampMs)&&l.value.maxMessageId===n.maxMessageId&&l.value.minMessageId===n.minMessageId;k==null?void 0:k.addQPLAnnotations({bool:{extended_range_is_identical_maw:a}})})["catch"](function(a){k==null?void 0:k.markQPLPoint("maw_extend_range_failed");k==null?void 0:k.addQPLAnnotations({string:{range_extension_error:a instanceof Error?a.message:"unknown_error"}});throw a})});return function(b,c,d,e,f){return a.apply(this,arguments)}}();this.$6=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,f,g,h,j){var l=e.$5(g);l==null?void 0:l.markQPLPoint("maw_wait_act_thread_start");var m=(yield d("MAWWaitForACTThreadReadyForMLv2").waitForACTThreadReadyForMLv2((yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton).tables,e.$1,"MAWMessageRangeDataSource",l));m=m.chatJid;l==null?void 0:l.markQPLPoint("maw_wait_act_thread_end");l==null?void 0:l.markQPLPoint("maw_fetch_messages_start");m=(yield d("MAWFetchMessagesForMLv2").fetchMessagesFromMAW({chatJid:m,direction:g,includeOriginalMsg:!0,pageSize:h,range:a}));if(m.success===!1){h=m.payload;h=h==null?"unknown":"["+h.name+"]: "+h.message;d("WATagsLogger").TAGS(["maw_message_core","MAWMessageRangeDataSource"]).ERROR(k(),m.error,h);if(c("gkx")("7409")&&m.payload instanceof d("MAWTimedBridge").MAWBridgeTimeoutError&&e.$3>0){l==null?void 0:l.markQPLPoint("maw_fetch_messages_timed_out");e.$3-=1;e.$7(f,babelHelpers["extends"]({},a,{isLoadingAfter:!1,isLoadingBefore:!1}),b);return}l==null?void 0:l.markQPLPoint("maw_fetch_messages_failed");throw(h=m.payload)!=null?h:c("err")("Failed to fetch messages from worker")}l==null?void 0:l.markQPLPoint("maw_fetch_messages_end");h=m.value;l==null?void 0:l.markQPLPoint("insert_msgs_to_lsdb_start");yield d("MAWPutMessagesToDB").insertMessageResponseIntoDatabase(yield i.LSDatabaseSingleton,h,j,l==null?void 0:l.getInstanceKey());l==null?void 0:l.markQPLPoint("insert_msgs_to_lsdb_end");l==null?void 0:l.markQPLPoint("maw_upsert_range_start");m=d("MAWMessagesRangesUtils").mergeMoreMessagesResponseIntoRange(a,b,h,g);j=m[0];a=m[1];e.$7(f,j,a);l==null?void 0:l.markQPLPoint("maw_upsert_range_end")});return function(b,c,d,e,f,g){return a.apply(this,arguments)}}();this.truncateMessageRange=function(a){};this.$1=a}var e=a.prototype;e.$7=function(a,b,c){b=this.$2.upsertRange(b);a.next({range:b.value,rangeExternalIds:c,type:"range_only"})};return a}();a=function(){function a(){var a=this;this.$1=new Map();this.getOrCreateMessageRangeCoveringCursor=function(b,c,d){var e=b.threadKey;return a.$2(e).getOrCreateMessageRangeCoveringCursor(b,c,d)};this.extendRange=function(b,c,d,e,f){var g=b.threadKey;return a.$2(g).extendRange(b,c,d,e,f)};this.truncateMessageRange=function(b){a.$1["delete"]((j||(j=d("I64"))).to_string(b))}}var b=a.prototype;b.$2=function(a){var b=(j||(j=d("I64"))).to_string(a);if(!this.$1.has(b)){a=new m(a);this.$1.set(b,a)}return c("nullthrows")(this.$1.get(b))};return a}();e=new a();g["default"]=e}),98);
__d("combineLatestWith",["relay-runtime"],(function(a,b,c,d,e,f,g){"use strict";function a(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return d("relay-runtime").Observable.create(function(a){var c=new Set(b),d=new Set(b),e=b.map(function(){return void 0}),f=b.map(function(b,f){return b.subscribe({complete:function(){d["delete"](b),d.size===0&&a.complete()},error:a.error,next:function(d){e[f]=d,c["delete"](b),c.size===0&&a.next(e)}})});return function(){f.forEach(function(a){return a.unsubscribe()})}})}g["default"]=a}),98);
__d("MAWEBCombinedRangeDataSource",["EBMessageRangeDataSource","I64","MAWMessageRangeDataSource","MLV2RangeExtensionLogger","Promise","asyncToGeneratorRuntime","combineLatestWith"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a,b){var c;c=(i||(i=d("I64"))).ge((c=a.range.minTimestampMs)!=null?c:(i||(i=d("I64"))).min_int,(c=b.range.minTimestampMs)!=null?c:(i||(i=d("I64"))).min_int)?[a.range,a.rangeExternalIds]:[b.range,b.rangeExternalIds];var e=c[0];c=c[1];return e.hasMoreBefore===!1?{minExternalId:c==null?void 0:c.minExternalId,minMessageId:(i||(i=d("I64"))).le(a.range.minTimestampMs,b.range.minTimestampMs)?a.range.minMessageId:b.range.minMessageId,minTimestampMs:(i||(i=d("I64"))).min(a.range.minTimestampMs,b.range.minTimestampMs)}:{minExternalId:c==null?void 0:c.minExternalId,minMessageId:e.minMessageId,minTimestampMs:e.minTimestampMs}}function k(a,b){var c=(i||(i=d("I64"))).le(a.range.maxTimestampMs,b.range.maxTimestampMs)?[a.range,a.rangeExternalIds]:[b.range,b.rangeExternalIds],e=c[0];c=c[1];return e.hasMoreAfter===!1?{maxExternalId:c==null?void 0:c.maxExternalId,maxMessageId:(i||(i=d("I64"))).ge(a.range.maxTimestampMs,b.range.maxTimestampMs)?a.range.maxMessageId:b.range.maxMessageId,maxTimestampMs:(i||(i=d("I64"))).max(a.range.maxTimestampMs,b.range.maxTimestampMs)}:{maxExternalId:c==null?void 0:c.maxExternalId,maxMessageId:e.maxMessageId,maxTimestampMs:e.maxTimestampMs}}var l=function(a){var e=this;this.getOrCreateMessageRangeCoveringCursor=function(a,b,d){b==null?void 0:b.annotateMessageRangesDataSource("MAWEBCombinedRangeDataSource");var f=c("MAWMessageRangeDataSource").getOrCreateMessageRangeCoveringCursor(a,b,d);b=c("EBMessageRangeDataSource")(e.$1).getOrCreateMessageRangeCoveringCursor(a,b,d);return c("combineLatestWith")(f,b).map(function(b){var c=b[0];b=b[1];var d=k(c,b),e=j(c,b);return{range:{hasMoreAfter:Boolean(c.range.hasMoreAfter||b.range.hasMoreAfter),hasMoreBefore:Boolean(c.range.hasMoreBefore||b.range.hasMoreBefore),isLoadingAfter:Boolean(c.range.isLoadingAfter||b.range.isLoadingAfter),isLoadingBefore:Boolean(c.range.isLoadingBefore||b.range.isLoadingBefore),maxMessageId:d.maxMessageId,maxTimestampMs:d.maxTimestampMs,minMessageId:e.minMessageId,minTimestampMs:e.minTimestampMs,threadKey:a.threadKey},rangeExternalIds:{maxExternalId:d.maxExternalId,minExternalId:e.minExternalId},type:"range_only"}})};this.extendRange=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,f,g,i,j){var k=d("MLV2RangeExtensionLogger").startRangeExtensionLoggerForThread(a.threadKey,g,a,i);yield (h||(h=b("Promise"))).all([c("EBMessageRangeDataSource")(e.$1).extendRange(a,f,g,i,j),c("MAWMessageRangeDataSource").extendRange(a,f,g,i,j)]).then(function(){k.markQPLSuccess()})["catch"](function(a){k.markQPLFailure(a);throw a})});return function(b,c,d,e,f){return a.apply(this,arguments)}}();this.truncateMessageRange=function(a){c("EBMessageRangeDataSource")(e.$1).truncateMessageRange(a),c("MAWMessageRangeDataSource").truncateMessageRange(a)};this.$1=a},m,n;function a(a){(m==null||n!==a)&&(n=a,m=new l(a));return m}g["default"]=a}),98);
__d("MWPFetchMessagesThreadLocks",["FBLogger","I64"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){var e=(h||(h=d("I64"))).to_string(b);return{lock:{after:function(){var b=f();b.after===!0&&c("FBLogger")("messenger_web_product").mustfix("Locking threadLockStatus twice");b.after=!0;a.set(e,b)},before:function(){var b=f();b.before===!0&&c("FBLogger")("messenger_web_product").mustfix("Locking threadLockStatus twice");b.before=!0;a.set(e,b)}},release:{after:function(){var b=f();b.after=!1;a.set(e,b)},before:function(){var b=f();b.before=!1;a.set(e,b)}},state:f()};function f(){var b=a.get(e);b==null&&(b={after:!1,before:!1},a.set(e,b));return b}}g.localThreadStatus=a}),98);
__d("MWPFetchMessagesPageV2",["FBLogger","LSFactory","LSIntEnum","LSIssueMessagesRangeQueryStoredProcedure","LSMailboxMessagesRangeQueryDirection","LSMessagingThreadTypeUtil","MWPFetchMessagesThreadLocks","asyncToGeneratorRuntime","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,d,e,f,g,h,j){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,i,j,k){var m,o;m=(yield (m=a.tables.messages_ranges_v2__generated).get.apply(m,f));if(m==null)return;o=h&&(yield (o=a.tables.messages_ranges_v2__generated).get.apply(o,h));if(o==null&&h!=null)return;h=d("LSMessagingThreadTypeUtil").isArmadilloSecure(g);var p=i!=null?d("LSMessagingThreadTypeUtil").isArmadilloSecure(i):!1;if(e==="before")if(m.hasMoreBefore)if(h)return l(a,b,e,m,j,g,k);else return n(a,f,m.threadKey,e);else if(o!=null)if(p)return l(a,b,e,o,j,g,k);else return n(a,[o.threadKey,o.minTimestampMs,o.minMessageId],o.threadKey,e);else return;else{e;if(m.hasMoreAfter)if(h)throw c("FBLogger")("messenger_web_product").mustfix("Not possible to fetch more after for secure messages");else return n(a,f,m.threadKey,e);else if(o!=null){p=d("LSMessagingThreadTypeUtil").isArmadilloSecure(c("nullthrows")(i));if(p)throw c("FBLogger")("messenger_web_product").mustfix("Not possible to fetch more after for secure messages");else return n(a,[o.threadKey,o.minTimestampMs,o.minMessageId],o.threadKey,e)}else return}});return i.apply(this,arguments)}var j=new Map(),k=new Map();function l(a,b,c,d,e,f,g){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h){var i=d("MWPFetchMessagesThreadLocks").localThreadStatus(j,e.threadKey);if(i.state[c])return;try{i.lock[c]();var k=(yield a.tables.messages.index("messageId").get(e.minMessageId));return yield f.fetchSecureMessagesProtocol(a,e.threadKey,g,k==null?void 0:k.primarySortKey,e,c,b,"user",h)}finally{i.release[c]()}});return m.apply(this,arguments)}function n(a,b,c,d){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,i){g=d("MWPFetchMessagesThreadLocks").localThreadStatus(k,g);if(g.state[i])return;try{g.lock[i]();return yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;b=(yield (b=a.messages_ranges_v2__generated).get.apply(b,e));if(!b)return;if(b.isLoadingBefore&&i==="before")return;if(b.isLoadingAfter&&i==="after")return;return c("LSIssueMessagesRangeQueryStoredProcedure")(c("LSFactory")(a),{direction:(h||(h=d("LSIntEnum"))).ofNumber(i==="before"?c("LSMailboxMessagesRangeQueryDirection").BEFORE:c("LSMailboxMessagesRangeQueryDirection").AFTER),referenceTimestampMs:b.minTimestampMs,threadKey:b.threadKey})});return function(b){return a.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":209")}finally{g.release[i]()}});return o.apply(this,arguments)}g["default"]=a}),98);
__d("MAWPreloadSecureMessages",["I64","LSAuthorityLevel","LSIntEnum","LSResult","MAWMessagesDirection","MWPFetchMessagesPageV2","MWV2OnAuthoritativeThreadInsert","Promise","ReQL","asyncToGeneratorRuntime","cr:13911","cr:13912"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=b("cr:13911")!=null?new(b("cr:13911"))():null,l=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,l,m,n){var o=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(e)));o=o!=null?[e,o==null?void 0:o.minTimestampMs,o==null?void 0:o.minMessageId]:null;g=g!=null?yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(g)):null;g=g!=null?[g==null?void 0:g.threadKey,g==null?void 0:g.minTimestampMs,g==null?void 0:g.minMessageId]:null;var p=(i||(i=d("I64"))).equal(f,(j||(j=d("LSIntEnum"))).ofNumber(15))?(j||(j=d("LSIntEnum"))).ofNumber(1):(j||(j=d("LSIntEnum"))).ofNumber(2);if(b("cr:13912")!=null){var q;if(!(i||(i=d("I64"))).equal(n,(j||(j=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE)))return(h||(h=b("Promise"))).resolve();var r=b("cr:13912")(a),s;n=(yield new(h||(h=b("Promise")))(function(a,b){s=r.getOrCreateMessageRangeCoveringCursor({externalId:null,messageId:null,threadKey:e,timestampMs:(i||(i=d("I64"))).max_int},void 0,l).subscribe({complete:a,error:b,next:function(b){a(b)}})}));(q=s)==null?void 0:q.unsubscribe();if(n&&d("MAWMessagesDirection").isFirstPageRange(n.range,"desc"))return r.extendRange(n.range,{maxExternalId:null,minExternalId:null},"desc",m,l)}else if(k!=null)return o!=null?c("MWPFetchMessagesPageV2")(a,m,"before",o,f,g,p,k,l):(h||(h=b("Promise"))).resolve()});return function(b,c,d,e,f,g,h){return a.apply(this,arguments)}}(),m=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){e=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.threads).getKeyRange(e)));if(e==null)return null;if((i||(i=d("I64"))).equal(e.authorityLevel,(j||(j=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE)))return e;var f=e.clientThreadKey;return f!=null?new(h||(h=b("Promise")))(function(b){d("MWV2OnAuthoritativeThreadInsert").onAuthoritativeThreadInsert(c("LSResult")(f),a,function(a){return b(a)})}):null});return function(b,c){return a.apply(this,arguments)}}();a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,d,e){c=(yield m(a,c));return c==null?(h||(h=b("Promise"))).resolve():l(a,c.threadKey,c.threadType,null,d,e,c.authorityLevel)});return function(b,c,d,e){return a.apply(this,arguments)}}();g.preloadSecureMessages=l;g.preloadSecureMessagesByThreadKey=a}),98);
__d("MAWPreloadSecureMessagesEager",["MAWPreloadSecureMessages","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){return(h||(h=b("Promise"))).resolve(d("MAWPreloadSecureMessages").preloadSecureMessages)}g.load=a}),98);
__d("MAWPreloadSecureMessagesRangeDataSource",["cr:9962"],(function(a,b,c,d,e,f,g){"use strict";g["default"]=b("cr:9962")}),98);